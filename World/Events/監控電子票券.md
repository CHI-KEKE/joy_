# 監控電子票券

## 目錄
1. [票券商品資訊](#1-票券商品資訊)
2. [票券發送機制](#2-票券發送機制)
3. [機器配置](#3-機器配置)
4. [定式回報](#4-定式回報)
5. [Athena 查詢](#5-athena-查詢)
6. [錯誤處理](#6-錯誤處理)

<br>

---

## 1. 票券商品資訊

**活動連結**：https://www.cuapp.com/page/CNY_eRedPacket_ProductCoupon

<br>

**商店**：28 CUAPP

<br>

### 1.1 商品清單

**商品**：$1000電子購物禮券 ($500X2張) 送$88電子購物禮券

<br>

Page ID：370490

<br>

開賣時間：2024/01/25 10:00:00 起 2024/02/09 23:59:00 止

<br>

庫存：4,800

<br>

**商品**：$1000電子購物禮券 ($100X10張) 送$88電子購物禮券

<br>

Page ID：370480

<br>

開賣時間：2024/01/25 10:00:00 起 2024/02/09 23:59:00 止

<br>

庫存：7,200

<br>

**商品**：$500電子購物禮券 ($100X5張) 送$38電子購物禮券

<br>

Page ID：370478

<br>

開賣時間：2024/01/25 10:00:00 起 2024/02/09 23:59:00 止

<br>

庫存：4,500

<br>

### 1.2 活動預估

16 天的活動期間共預留 1 萬 6 千套票券, 最高營業額可達 $17,000,000 港幣，且只供 CUAPP 線上購買

<br>

連結 / 宣傳：15 間門市店內宣傳 / Facebook / 會員app push / CU APP front page update

<br>

---

## 2. 票券發送機制

EDA：OrderCreated —> EVoucherOrderCreated

<br>

![alt text](./image-1.png)

<br>

![alt text](./image-2.png)

<br>

---

## 3. 機器配置

調整 SCM API 機器配置

<br>

固*1+ASG*1 -> 固*1+ASG*3

<br>

![alt text](./image-3.png)

<br>

---

## 4. 定式回報

監控開賣當下流量無明顯增加。

<br>

CPU 大約10-20%

<br>

第一筆交易 於 2024-01-25 10:02:26 進來

<br>

且已完成取票

<br>

目前監控只有賣出 1 張券

<br>

$500 電子購物禮券 ($100X5張) 送$38電子購物禮券

<br>

### 4.1 回報格式

[HK] CUAPP電子票券監控回報

<br>

MWeb CPU 平均: x %

<br>

SCMAPI CPU 平均: x %

<br>

Elmah: 無特殊錯誤

<br>

---

## 5. Athena 查詢

### 5.1 查詢 /SalesOrder/Get 狀態

可查詢 VipMemberInfo 問題

<br>

```sql
SELECT * FROM "hk_prod_osm"."osm_api_nlog" 
WHERE controller = 'SalesOrder'
and date = '2023/04/14'
and action = 'Get'
and field4 like '%TG230414R00028%'
--and requestid = '{"message":"202209262311209082'
```

<br>

---

## 6. 錯誤處理

### 6.1 超過一小時訂單未出貨完成異常

1. 通報請 owner 協助確認 超過一小時訂單未出貨完成異常電子票券：TS230406P000113

<br>

2. Grafana 確認付款 paymentmiddleware 過程

<br>

3. 確認Order API

<br>

https://api.91app.hk/scm/v2/SalesOrder/CheckIsValid 

<br>

這支 API 來確認，沒有紀錄你們 api 的 response，但從結果可以推論當時你們的 api 應該是回覆 Result: "Invaild"

<br>

判斷 Result 是 Invalid 就會發送 OrderFailed 的事件，之後就會中斷流程處理

<br>

Athena 可查

<br>

![alt text](./image-4.png)

<br>

程式碼

<br>

![alt text](./image-5.png)

<br>

### 6.2 轉單中斷處理

NMQV3 就不會建 EVoucherOrderCreated 繼續後面的流程，因此要走上面第二步手動執行

<br>

若大表狀態 OrderSlaveFlow_StatusForUserDef,OrderSlaveFlow_StatusForSCMDef 皆為 WaitingToShipping, 須執行 EVoucherOrderCreatedProcess 的程式邏輯

<br>

若 OrderSlaveFlow_StatusForUserDef,OrderSlaveFlow_StatusForSCMDef 皆為 ConfirmedToShipping ，代表已經打了 Request API 給 Robin Che,可使用 TGCode 去反查 NMQV3 EVoucherOrderCreated Task Log，並附上執行時間及 log

<br>

OSM 介面查詢訂單(確認票券已出貨)

<br>

![alt text](./image-6.png)

<br>

---