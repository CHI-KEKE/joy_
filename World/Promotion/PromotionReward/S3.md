# S3 文件

## 目錄
1. [RuleRecord](#1-rulerecord)
2. [回收點數不足紀錄 S3](#2-回收點數不足紀錄-s3)

<br>

---

## 1. RuleRecord

### 儲存路徑格式說明

<br>

{環境路徑}/Promotion/Reward/{ShopId}/{PromotionEngineId}/{Identity}_{PromotionEngineDateTime:yyMMddHHmmss}.json


TWQA : 91dev-ap-northeast-1-private-tw-osm
HKQA : 91dev-ap-southeast-1-private-hk-osm

<br>

### 路徑舉例

<br>

91dev-ap-southeast-1-private-hk-osm/QA/Promotion/Reward/2/5977/2_5977_250206114332.json

<br>

### 節點與欄位意義

<br>

**商品（料號）資訊**

<br>

節點位置：SaleProducts

<br>

| 欄位名 | 說明 |
|-------|------|
| TagId | PromotionTag ID |
| ProductionSkuCode | 料號（商品 SKU 編碼） |

<br>

生效條件：

<br>

- TargetType = SalePage 且 IncludeProductSkuOuterIdList 有資料
- 或 ExcludeTargetType = SalePage 且 ExcludeProductSkuOuterIdList 有資料

<br>

**門市資訊**

<br>

節點位置：Locations

<br>

| 欄位名 | 說明 |
|-------|------|
| TagId | 門市標籤 ID |
| LocationId | 指定門市 ID |

<br>

生效條件：

<br>

- TargetLocationType = Location
- 且 IncludeTargetLocationIdList 有資料

<br>

### 設定邏輯（與 Rule 內部資料關聯）

<br>

| 類型 | 條件 | Scope 類型 |
|------|------|------------|
| 所有門市 | TargetLocationType = All | AllLocationScope |
| 指定門市 | TargetLocationType = Location | TagLocationScope + TagId |

<br>

### Sample

<br>

```json
{
  "Identity": "2:5783",
  "ShopId": 2,
  "PromotionEngineId": 5783,
  "PromotionEngineDateTime": "2025-02-06T11:43:32.5625219+08:00",
  "StartDateTime": "2025-02-07T00:00:00",
  "EndDateTime": "2025-02-09T00:00:00",
  "Rule": "{\"TypeFullName\":\"NineYi.Msa.Promotion.Rule.RewardReachPriceWithPoint2\",\"Id\":5783,\"Name\":\"Api 新增給點活動0206_Local_測支援料號_00001\",\"Enabled\":true,\"Description\":\"xxxxxxxxxxxxxxxxxxx\",\"Since\":\"2025-02-07T00:00:00\",\"Until\":\"2025-02-09T00:00:00\",\"UpdatedAt\":\"2025-02-06T11:43:35.2962914+08:00\",\"Cyclable\":true,\"Accumulated\":false,\"IncludedProductScopes\":[{\"ProductScopeType\":\"NineYi.Msa.Tagging.TagProductScope\",\"Tag\":\"Collection:f_278128551560613120\"},{\"ProductScopeType\":\"NineYi.Msa.Tagging.TagProductScope\",\"Tag\":\"4980\"}],\"ExcludedProductScopes\":null,\"IncludeRegionScopes\":[{\"RegionScopeType\":\"NineYi.Msa.Promotion.Engine.AllCountryRegionScope\"}],\"MatchedUserScopes\":[{\"UserScopeType\":\"NineYi.Msa.Promotion.Engine.AllUserScope\"}],\"VisibleUserScopes\":[{\"UserScopeType\":\"NineYi.Msa.Promotion.Engine.AllUserScope\"}],\"MatchedSalesChannels\":31,\"VisibleSalesChannels\":31,\"IncludedLocationScopes\":[{\"LocationScopeType\":\"NineYi.Msa.Promotion.Engine.AllLocationScope\"}],\"IsLimitedAddOnsPurchaseQty\":false,\"Thresholds\":{\"CrmShopMemberCard:5\":{\"ReachPricePointPairs\":[{\"ReachPrice\":100.0,\"Point\":10.0}]},\"CrmShopMemberCard:30\":{\"ReachPricePointPairs\":[{\"ReachPrice\":200.0,\"Point\":20.0}]}],\"PointUntil\":{\"UntilType\":1,\"AfterDays\":15,\"UntilYearOffset\":0,\"UntilYearMonth\":12,\"FixedDate\":\"0001-01-01T00:00:00\"}}",
  "MemberTier": null,
  "SaleProducts": [
    {
      "TagId": 4980,
      "SalePageId": 0,
      "SaleProductSkuId": 0,
      "ProductionSkuCode": "AAA"
    },
    {
      "TagId": 4980,
      "SalePageId": 0,
      "SaleProductSkuId": 0,
      "ProductionSkuCode": "CCC"
    }
  ],
  "Locations": null,
  "PromotionType": "RewardReachPriceWithPoint2",
  "RewardPointConditions": [
    {
      "SourceTypeDef": "ECom",
      "DeliveryMethod": "Home",
      "StatusDef": "WaitingToShipping",
      "RewardDays": 0
    },
    {
      "SourceTypeDef": "ECom",
      "DeliveryMethod": "Oversea",
      "StatusDef": "WaitingToShipping",
      "RewardDays": 0
    },
    {
      "SourceTypeDef": "ECom",
      "DeliveryMethod": "LocationPickup",
      "StatusDef": "WaitingToShipping",
      "RewardDays": 0
    },
    {
      "SourceTypeDef": "Others",
      "DeliveryMethod": null,
      "StatusDef": null,
      "RewardDays": 0
    }
  ],
  "IncludeCollectionIds": [
    "Collection:f_278128551560613120"
  ],
  "ExcludeCollectionIds": null
}
```

<br>

---

## 2. 回收點數不足紀錄 S3

<br>

點數回收但消費者點數不足無法寫紀錄在S3

<br>

**Slack 討論串**：https://91app.slack.com/archives/C089M6NLMN0/p1748499354725569

<br>

**申請工單**：https://teamroom.91app.biz/issues/24232

<br>

### 問題說明

<br>

點數回收有個邏輯是，若點數回發現消費者點數不足會寫紀錄在 S3，但由於 code 從 loyalty 搬到 promotion-service，目前 promotion-service 會沒有權限讀寫 S3。目前點數還是會正常回收，但就不會有S3紀錄，DDB 也不會更新狀態。

<br>

### 程式碼位置

<br>

C:\91APP\Promotion\nine1.promotion.worker\src\Nine1.Promotion.Console.BL\Services\PromotionReward\LoyaltyPointService.ProcessRecyclePointAsync

<br>

```csharp
if (recycleResult.ResultCode == "api_0000" || recycleResult.ResultCode == "api_0021")
{
    //// 餘額不足紀錄 記錄在第一筆Detail 
    var firstTsDetail = tsRewardDetail.First(i => i.Seq == 0);

    this._logger.LogInformation($"還點結果：{recycleResult.ResultMessage}");
    if (string.IsNullOrWhiteSpace(recycleResult.ResultData?.ResponseData) == false && recycleResult.ResultData.ResponseData.Contains("點數餘額不足"))
    {
        var s3RecordData = this.GetRecyclePointInsufficientRecordEntity(recycleRequest, recycleResult, record.VipMemberId);
        var key = $"{this._configuration["N1_ENVIRONMENT"]}" +
                  $"/RecyclePointInsufficient/" +
                  $"{s3RecordData.ShopId}/" +
                  $"{DateTime.Now.Date:yyyyMM}/" +
                  $"{DateTime.Now.Date:yyyyMMdd}/" +
                  $"LoyaltyPoint_{s3RecordData.OrderId}_{DateTime.Now:yyyyMMddHHmmss}.json";
        await this._storage.PutItem(this._osmBuckyName, key, s3RecordData);

        firstTsDetail.InsufficientPoints = s3RecordData.InsufficientPoints;
    }
    else if (string.IsNullOrEmpty(recycleResult.ResultMessage) == false && recycleResult.ResultMessage.Contains("會員點數餘額為0"))
    {
        firstTsDetail.InsufficientPoints = recyclePoint;
    }

    if (firstTsDetail.InsufficientPoints > 0)
    {
        await this._dynamoDBClient.UpdateItemAsync(this._promotionRewardDetailTableName, firstTsDetail);
    }
}
```

<br>




