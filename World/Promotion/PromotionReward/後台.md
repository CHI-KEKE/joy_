# å¾Œå°æ–‡ä»¶

## ç›®éŒ„
1. [ä¿ƒè³¼å¾Œå°](#1-ä¿ƒè³¼å¾Œå°)
2. [OSM API](#2-osm-api)

<br>

---

## 1. ä¿ƒè³¼å¾Œå°

### 1.1 å…±ç”¨è³‡è¨Š

**Endpoint**ï¼šapi/promotion-rules

<br>

**ä½ç½®**ï¼šC:\91APP\Promotion\webapi\nine1.promotion.web.api\src\Web\Nine1.Promotion.Web.Api\Controllers\PromotionEngineController.cs

<br>

**æ´»å‹•é¡å‹å®šç¾©**

<br>

- æ–°ç‰ˆçµ¦é»æ´»å‹•é¡å‹ï¼šRewardReachPriceWithPoint2, RewardReachPriceWithRatePoint2
- æ–°ç‰ˆçµ¦åˆ¸æ´»å‹•é¡å‹ï¼šRewardReachPriceWithCoupon

<br>

### 1.2 MemberCollection

ç¢ºèªç™½åå–®è¨­å®š

<br>

æ´»å‹•å°è±¡ç‚ºå…¨åº—å‰‡éœ€æŒ‡å®š MemberCollectionId = -1

<br>

```csharp
//// å…è¨±æŒ‡å®šå®¢ç¾¤æ´»å‹•é¡å‹ï¼Œä¸”æ´»å‹•å°è±¡ç‚ºå…¨åº—ï¼Œå‰‡å°‡MemberCollectionIdè¨­ç‚º-1(ä¸æŒ‡å®š)ï¼Œå…¶é¤˜ç©ºå€¼ç‚ºä¸æ”¯æ´
if (entity.TargetMemberTypeDef == nameof(PromotionEngineTargetMemberTypeDefEnum.All) &&
            this._enableMemberCollectionPromotionType.Contains(entity.TypeDef))
{
     entity.MemberCollectionId = "-1";
}
```

<br>

è«‹åƒè€ƒç›®å‰å·²å¯¦ä½œæ”¯æ´å®¢ç¾¤çš„æ´»å‹•é¡å‹ï¼šDiscountByMemberWithPrice

<br>

by ç’°å¢ƒè¨­å®šæ˜¯å¦èµ°æ–°ç‰ˆ MemberCollection é–‹é—œ

<br>

- Tableï¼šShopStaticSetting
- Groupï¼šPromotionEngine
- Keyï¼šSupportMemberCollectionShop

<br>

ç¯„ä¾‹ï¼šHK_QAï¼š2|noneï¼Œå‰é¢ç‚ºç™½åå–®ï¼Œå¾Œé¢æ˜¯é»‘åå–®

<br>

ç¨‹å¼ç¢¼æµç¨‹ä¸­ï¼Œå„²å­˜æ™‚éœ€ç¢ºèªç›¸é—œ DB æ¬„ä½æ­£ç¢ºè¨­å®šå„²å­˜

<br>

- PromotionEngine_TargetMemberTypeDef = MemberCollection
- PromotionEngine_UpdatedUser = SyncPromotionTagToCollection
- PromotionEngine_DisplaySetting = Member / All ??
- PromotionEngine_MemberCollectionId = 93be0653-4a61-4d8d-9a24-530d992675fa(ç¯„ä¾‹)(entity.MemberCollectionId ?? string.Empty;)

<br>

ç¢ºèªè¨­å®š Rule çš„éƒ¨åˆ†

<br>

```csharp
//// è¨­å®šæ´»å‹•å°è±¡ç¯„åœ
ruleService.SetMatchedUserScopes(entity.TargetMemberType, entity.CrmShopMemberCardIds, entity.MemberCollectionId);
```

<br>

### 1.3 GET API

#### 1.3.1 URL

urlï¼š/api/promotion-rules/get

<br>

#### 1.3.2 é»æ•¸æ°¸ä¹…æ•ˆæœŸ

ğŸ” æª”æ¡ˆ

<br>

C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngineRules\RewardReachPriceWithPoint2RuleService.cs

<br>

ğŸ—‚ï¸ æ–¹æ³•

<br>

ParsePromotionEngineRuleObject

<br>

#### 1.3.3 TG ä¸Šé™

ğŸ” æª”æ¡ˆ

<br>

C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngineRules\RewardReachPriceWithPoint2RuleService.cs

<br>

ğŸ—‚ï¸ æ–¹æ³•

<br>

ParsePromotionEngineRuleObject

<br>

#### 1.3.4 ä½”é¡

ğŸ” æª”æ¡ˆ

<br>

- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngines\PromotionEngineService.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngineRules\IPromotionEngineRuleService.cs

<br>

**æµç¨‹**

<br>

```csharp
/// ä½”é¡
if (PromotionEngineHelper.IsQuotaSupportedPromotionTypes(result.TypeDef))
{
    result.Quota = ruleService.GetCustomField2ToEntity<int>(promotionEngineSetting.PromotionEngineSetting_CustomField2, 0);
}
```

<br>

PromotionEngineSetting_CustomField2

<br>

å¯¦ä½œ T GetCustomField2ToEntity<T>(string customField2, T defaultValue);

<br>

```csharp
/// <summary>
/// å–å¾—è‡ªè¨‚è¦å‰‡ 2
/// </summary>
/// <param name="customField2">PromotionEngineSetting_CustomField2</param>
/// <param name="defaultValue">é è¨­å€¼</param>
/// <returns>T</returns>
public override T GetCustomField2ToEntity<T>(string customField2, T defaultValue)
{
    var splitCustomField = customField2.Split(":");
    if (string.IsNullOrEmpty(customField2) || splitCustomField == null || splitCustomField.Length < 1)
    {
        return defaultValue;
    }

    return (T)Convert.ChangeType(splitCustomField[1], typeof(T));
}
```

<br>

### 1.4 Update API

#### 1.4.1 URL

api/promotion-rules/update

<br>

#### 1.4.2 UpdatePromotionRequestEntity èªªæ˜

C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.BE\Promotions\Requests\UpdatePromotionRequestEntity.cs

<br>

âœ… **ç”¨é€”**

<br>

UpdatePromotionRequestEntity æ˜¯æ›´æ–°ä¿ƒéŠ·æ´»å‹•æ™‚ä½¿ç”¨çš„ API è«‹æ±‚ç‰©ä»¶ï¼Œå®Œæ•´æ‰¿è¼‰ä¸€ç­†ä¿ƒéŠ·æ´»å‹•çš„æ‰€æœ‰è¨­å®šï¼Œä¾›å¾Œç«¯é€²è¡Œï¼š

<br>

- æ¬„ä½é©—è­‰
- èˆ‡è³‡æ–™åº«æ¯”å°
- å¯«å…¥æ›´æ–°
- åŸ·è¡Œä¿ƒéŠ·é‚è¼¯

<br>

**ç¹¼æ‰¿ä¾†æº**ï¼šPromotionBaseEntity â†’ å› æ­¤è‡ªå‹•åŒ…å«æ‰€æœ‰æ´»å‹•çš„å…±é€šæ¬„ä½å±¬æ€§

<br>

ğŸ”‘ **ä¸»è¦çµæ§‹**

<br>

**1ï¸âƒ£ å…±é€šæ¬„ä½ (PromotionBaseEntity)**

<br>

| æ¬„ä½åç¨± | èªªæ˜ |
|----------|------|
| ShopId | å•†åº—åºè™Ÿï¼Œä»£è¡¨æ´»å‹•æ‰€å±¬åº—å®¶ |
| Id | æ´»å‹•å”¯ä¸€åºè™Ÿï¼Œæ›´æ–°æ™‚å¿…å¡« |
| Name | æ´»å‹•åç¨± |
| Description | æ´»å‹•æè¿° |
| TypeDef | æ´»å‹•æŠ˜æ‰£é¡å‹ï¼Œå°æ‡‰ä¿ƒéŠ·é‚è¼¯ |
| StartDateTime / EndDateTime | æ´»å‹•æœŸé–“ |
| IsRegular | æ˜¯å¦ç‚ºå¸¸æ…‹æ´»å‹• |
| HasPicture | æ´»å‹•æ˜¯å¦åŒ…å«åœ–ç‰‡ |
| Terms / AgreeContent | æ´»å‹•æ¢æ¬¾èˆ‡åŒæ„å…§å®¹ |

<br>

**2ï¸âƒ£ ğŸ§© ç›®æ¨™å°è±¡è¨­å®š**

<br>

| æ¬„ä½åç¨± | èªªæ˜ |
|----------|------|
| TargetMemberType / TargetMemberTypeDef | ç›®æ¨™æœƒå“¡é¡å‹ï¼ˆå¦‚æ‰€æœ‰æœƒå“¡ã€VIPï¼‰ |
| CrmShopMemberCardIds | æŒ‡å®šæœƒå“¡å¡ç­‰ç´š ID æ¸…å–® |
| PromotionTargetRegionType | é…é€å€åŸŸç¯„åœï¼ˆå…¨å€/åˆ†å€ï¼‰ |
| IncludeTargetRegionIdList | æŒ‡å®šé…é€å€åŸŸæ¸…å–® |
| TargetLocationType | é–€å¸‚ç¯„åœé¡å‹ï¼ˆå…¨åº—/éƒ¨åˆ†é–€å¸‚ï¼‰ |
| IncludeTargetLocationIdList | æŒ‡å®šé–€å¸‚ ID |
| TargetPlatformTypeList | é©ç”¨é€šè·¯é¡å‹ï¼ˆå®˜ç¶²/APP ç­‰ï¼‰ |

<br>

**3ï¸âƒ£ ğŸ·ï¸ æŒ‡å®š / æ’é™¤å•†å“ç¯„åœ**

<br>

| æ¬„ä½åç¨± | èªªæ˜ |
|----------|------|
| TargetType / TargetTypeDef | æ´»å‹•é©ç”¨ç¯„åœï¼ˆå¦‚å…¨åº—ã€æŒ‡å®šå•†å“ï¼‰ |
| IncludeTargetIdList | æŒ‡å®šçš„å•†å“æˆ–åˆ†é¡ ID æ¸…å–® |
| IncludeProductSkuOuterIdList | æŒ‡å®šå•†å“ SKUï¼ˆå¤–éƒ¨ç·¨è™Ÿï¼‰ |
| ExcludeTargetIdList | æ’é™¤çš„å•†å“ ID æ¸…å–® |
| ExcludeProductSkuOuterIdList | æ’é™¤çš„ SKU æ¸…å–® |

<br>

**4ï¸âƒ£ ğŸ›ï¸ ä¿ƒéŠ·è¦å‰‡**

<br>

| æ¬„ä½åç¨± | èªªæ˜ |
|----------|------|
| DiscountRuleList | æŠ˜æŠµè¦å‰‡ï¼ˆæ»¿é¡æŠ˜æŠµï¼‰ |
| GiftRuleList | è´ˆå“è¦å‰‡ï¼ˆæ»¿é¡è´ˆå“ï¼‰ |
| AddOnsRuleList | åŠ åƒ¹è³¼å•†å“è¨­å®š |
| IsCyclable | æ˜¯å¦å¾ªç’°åŸ·è¡Œ |
| Accumulated | æ˜¯å¦ç´¯è´ˆï¼ˆç´¯ç©å¤šæ¬¡ï¼‰ |
| IsMultiLevel | æ˜¯å¦å¤šéšå±¤è¨­å®š |
| CanUseECoupon | æ˜¯å¦å¯èˆ‡æŠ˜åƒ¹åˆ¸ä½µç”¨ |
| CalculateTypeDef | èˆ‡å…¶ä»–æ´»å‹•è¨ˆç®—é‚è¼¯ |

<br>

**5ï¸âƒ£ ğŸ çµ¦é» / çµ¦åˆ¸**

<br>

| æ¬„ä½åç¨± | èªªæ˜ |
|----------|------|
| RewardPointConditions | èˆŠç‰ˆçµ¦é»æ¢ä»¶ï¼ˆå·²æ¨™è¨˜ Obsoleteï¼‰ |
| RewardConditions | æ–°ç‰ˆçµ¦é»æ¢ä»¶ |
| RewardPointRuleList | çµ¦é»è¦å‰‡æ¸…å–®ï¼ˆæ»¿é¡çµ¦é»ç´°ç¯€ï¼‰ |
| RewardCouponRuleList | çµ¦åˆ¸è¦å‰‡æ¸…å–® |
| PeriodType | é»æ•¸æ•ˆæœŸè¨­å®š |
| PromotionRewardPointCalculateTypeDef | é»æ•¸è¨ˆç®—æ–¹å¼ï¼ˆç™¾åˆ†æ¯”ã€å›ºå®šå€¼ç­‰ï¼‰ |

<br>

**6ï¸âƒ£ ğŸ“¦ å…¶ä»–è¨­å®š**

<br>

| æ¬„ä½åç¨± | èªªæ˜ |
|----------|------|
| IsDisplayInShoppingCart | æ˜¯å¦åœ¨è³¼ç‰©è»Šé¡¯ç¤ºæ´»å‹•è¨Šæ¯ |
| IsAddOnsThresholdEligible | åŠ è³¼å“æ˜¯å¦å¯ä½œç‚ºæ»¿é¡é–€æª» |
| PayTypes / ShippingTypes | é™å®šçš„ä»˜æ¬¾ / é…é€æ–¹å¼ |
| Label | æ´»å‹•æ¨™ç±¤ |
| UpdatedUser / UpdatedDateTime | æ›´æ–°è€…èˆ‡æ›´æ–°æ™‚é–“ |
| IsNeedRecordIo | æ˜¯å¦éœ€è¦è¨˜éŒ„æ­·ç¨‹ï¼ˆI/Oï¼‰ |
| Sort | æ’åºé †åº |

<br>

#### 1.4.3 ä½”é¡

C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngines\PromotionEngineService.cs

<br>

```csharp
//// æ”¯æ´ä½”é¡çš„æ´»å‹•é¡å‹, 0 è¡¨ç¤ºä¸é™æ¬¡æ•¸
if (PromotionEngineHelper.IsQuotaSupportedPromotionTypes(updateRequest.TypeDef))
{
    originSetting.PromotionEngineSetting_CustomField2 = $"{nameof(updateRequest.Quota)}:{updateRequest.Quota}";
}
```

<br>

#### 1.4.4 æ°¸ä¹…æ•ˆæœŸ

Create å¯«éå°±å¥½äº†

<br>

#### 1.4.5 TG ä¸Šé™

Create æ–°å¢å³å¯

<br>

#### 1.4.6 æ´»å‹•é€²è¡Œä¸­ä¸èƒ½æ”¹çš„æ¬„ä½

é€šè·¯

<br>

### 1.5 CREATE API

#### 1.5.1 URL

/api/promotion-rules/create

<br>

#### 1.5.2 å›é¥‹é»æ•¸ä¸Šé™

å·²çŸ¥ç›®å‰æ–°ç‰ˆä¾æ¯”ä¾‹çµ¦é»æ´»å‹•é¡å‹ (RewardReachPriceWithRatePoint2) å·²å¯¦ä½œï¼Œè«‹åƒè€ƒè©²ä½œæ³•å¯¦ä½œåœ¨æ–°ç‰ˆå›ºå®šçµ¦é»æ´»å‹•é¡å‹ (RewardReachPriceWithPoint2)

<br>

éœ€è€ƒé‡åˆ°æ–°èˆŠç›¸å®¹ (é è¨­å€¼æ‡‰è©²æ˜¯å¤šå°‘)

<br>

è³‡æ–™æœƒå¾ PromotionBaseEntity.RewardPointRule.MaxRewardPoint ç¯€é»å‚³å…¥ Controller

<br>

ä¿ƒè³¼å¼•æ“éœ€ä¿®æ”¹ RewardReachPriceWithPointThreshold åŠ ä¸Š MaximumPoints (åƒè€ƒ RewardReachPriceWithRatePointThreshold)

<br>

ParsePromotionEngineRuleObject æ™‚éœ€å¾ threshold æ­£ç¢º mapping MaxRewardPoint å‡ºä¾†è®“ PromotionEngine_Rule å¯ä»¥å­˜å–

<br>

éœ€æ–¼é©—è­‰å™¨ PromotionBaseValidator é‡å° MaximumPoints å¯¦ä½œä»¥ä¸‹è¦å‰‡ï¼š

<br>

- åƒ…å¯è¼¸å…¥åŠå½¢æ•¸å­—
- çµ¦é»ä¸Šé™ä¸å¾—å°æ–¼å›ºå®šçµ¦é»çš„é»æ•¸ (åƒ…å›ºå®šçµ¦é»æª¢æ ¸)ï¼šé ˆå¤§æ–¼å–®æ¬¡å›é¥‹çš„é»æ•¸
- é»æ•¸ä¸Šé™ç‚º 9,999,999ï¼Œè¼¸å…¥è¶…éçš„éŒ¯èª¤è¨Šæ¯ï¼šé»æ•¸ä¸Šé™ç‚º 9,999,999

<br>

**åƒè€ƒæª”æ¡ˆ**

<br>

C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngineRules\RewardReachPriceWithRatePoint2RuleService.cs

<br>

**å¯¦ä½œæª”æ¡ˆ**

<br>

C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngineRules\RewardReachPriceWithPoint2RuleService.cs

<br>

#### 1.5.3 æ°¸ä¹…æ•ˆæœŸ

PromotionRewardPointPeriodTypeEnum éœ€æ–°å¢ enum Permanent è¡¨ç¤ºè©²æ´»å‹•å›é¥‹çš„é»æ•¸ç‚ºæ°¸ä¹…æ•ˆæœŸ

<br>

å‰ç«¯æœƒå¾ç¯€é» CreatePromotionRequestEntity.PeriodType.RewardPointPeriodType å‚³å…¥

<br>

å°æ‡‰çš„æ´»å‹•é¡å‹çš„ RuleService éœ€è¦åœ¨ GetPromotionEngineRule æ–¹æ³•ä¸­ Parse ä¸¦è™•ç†è©² Enum åˆ° PointUntil

<br>

è³‡æ–™å¯ä»¥æ”¾åœ¨ PromotionEngineRuleEntity.PeriodType ä¸­ï¼Œå­˜å…¥ PromotionEngine_Rule

<br>

**æª”æ¡ˆä½ç½®**

<br>

- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.BE\Promotions\Requests\CreatePromotionRequestEntity.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.BE\Promotions\PromotionBaseEntity.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\Common\Nine1.Promotion.Common.Validators\Promotions\PromotionBaseValidator.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.BE\Promotions\PromotionRewardPointPeriodTypeEntity.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.BE\Promotions\Enums\PromotionRewardPointPeriodTypeEnum.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngines\PromotionEngineService.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngineRules\RewardReachPriceWithPoint2RuleService.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngineRules\RewardReachPriceWithRatePoint2RuleService.cs

<br>

#### 1.5.4 ä½”é¡

éœ€æ–°å¢ MaxRewardTimesPerMember ç¯€é»å–å¾—å‰ç«¯çš„ä½”é¡æ•¸å­—ä¸¦å„²å­˜ (è¦å°é½Šç«™é¡çš„ api åç¨±)

<br>

ç¯€é»è¦åŒ…ä¸€å€‹ entity å—

<br>

**PromotionEngineSetting Table**

<br>

- Tableï¼šPromotionEngineSetting
- Columnï¼šPromotionEngineSetting_CustomField2

<br>

**é©—è­‰å™¨ (PromotionBaseEntity)**

<br>

- ä¸Šé™ï¼®æ¬¡ï¼ˆé è¨­æ­¤é¸é …ï¼‰ï¼Œè‹¥é¸æ­¤é …ï¼Œå‰‡ï¼®ç‚ºå¿…å¡«å¯«
- æ­¤ï¼®æ¬„ä½æœ€å¤šè¼¸å…¥ 1-30ï¼Œè‹¥è¼¸å…¥éåŠå½¢æ•¸å­—ï¼Œéœ€è¦å‡ºç¾éŒ¯èª¤è¨Šæ¯ï¼šè«‹è¼¸å…¥åŠå½¢æ•¸å­—
- ç„¡ä¸Šé™
- æ–°èˆŠç›¸å®¹ (èˆŠçš„æ´»å‹•æ²’æœ‰ä½”é¡æ¦‚å¿µï¼Œç·¨è¼¯æ™‚è¦ç¢ºä¿çµ¦é è¨­å€¼ï¼Œä½†é è¨­å€¼æ˜¯ N æ¬¡ï¼Œè¦å®šç¾©æ¸…æ¥šå¤šå°‘)

<br>

**åƒè€ƒæª”æ¡ˆ**

<br>

- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.BE\Promotions\PromotionBaseEntity.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngines\PromotionEngineService.cs

<br>

### 1.6 Parse Scopes

**Item1ï¼šproductScopePairs**

<br>

- includedScopesï¼šIncludedProductScopes,TagId
- excludedScopesï¼šExcludedProductScopes,TagId

<br>

**Item2ï¼šuserScopePairs**

<br>

- MatchedUserScopes
- VisibleUserScopes

<br>

**Item3ï¼šrewardPointRules**

<br>

**Item4ï¼šrewardPointPeriodType**

<br>

**Item5ï¼šcalculateTypeDef**

<br>

**Item6ï¼šlocationScopePairs**

<br>

- IncludedLocationScopesï¼šIncludedLocationScopes,TagId

<br>

### 1.7 matchedSalesChannels

```json
"matchedSalesChannels": [
    "Web",
    "AppIOS",
    "AppAndroid",
    "LocationWizard",
    "InStore"
]
```

<br>

s3 çš„ rule ç¯€é»æœ‰å€‹ "MatchedSalesChannels":31

<br>

```csharp
[Flags]
public enum SalesChannelEnum
{
    Web = 1,
    AppIOS = 2,
    AppAndroid = 4,
    LocationWizard = 8,
    InStore = 0x10
}
```

<br>

### 1.8 æ–™è™Ÿæ•¸é‡

productsku-outerid-count

<br>

### 1.9 åŒ¯å‡ºæ–™è™Ÿæ¸…å–®

productsku-outerid-list

<br>

### 1.10 ç•°å‹•æ–™è™Ÿ

<br>

### 1.11 æ¸¬è©¦è³‡æ–™

**å•†å“**ï¼š[61284,61361,61296]

<br>

**æ–™è™Ÿ**ï¼š["aaa","zzz"]

<br>

Collection:f_278806561465963776

<br>

OuterIdTag:5022

<br>

==> ProductScopeType NineYi.Msa.Promotion.Engine.AllProductScope

<br>

location tag 5023

<br>

---

## 2. OSM API

### 2.1 CREATE API

#### 2.1.1 é—œéµå­—

"Create"

<br>

#### 2.1.2 èˆŠæ´»å‹•é©ç”¨é–€å¸‚ API

https://sms.qa1.hk.91dev.tw/Api/Location/GetListForAll

<br>

#### 2.1.3 OSM æ´»å‹•æ–°å¢ API

https://sms.qa1.hk.91dev.tw/Api/PromotionEngine/Create

<br>

#### 2.1.4 æ–™è™Ÿé™åˆ¶

**åºè™Ÿ**ï¼š10,000

<br>

**æ–™è™Ÿ**ï¼š10,000

<br>

#### 2.1.5 ä½”é¡

**æª”æ¡ˆä½ç½®**

<br>

- BusinessLogic/BE/PromotionEngines/PromotionEngineBaseEntity.cs
- BusinessLogic/BE/Nine1Promotions/Requests/CreatePromotionRequestEntity.cs  
- BusinessLogic/Services/PromotionEngines/PromotionEngineService.cs

<br>

```csharp
/// <summary>
/// ä½”é¡ (æœƒå“¡å›é¥‹æ¬¡æ•¸ä¸Šé™)
/// 0 : ä¸é™æ¬¡æ•¸
/// </summary>
public int Quota { get; set; }
```

<br>

```csharp
this._quotaSupportedPromotionTypeList = new List<string>
{
    nameof(PromotionEngineTypeDefEnum.RewardReachPriceWithPoint2),
    nameof(PromotionEngineTypeDefEnum.RewardReachPriceWithRatePoint2),
    nameof(PromotionEngineTypeDefEnum.RewardReachPriceWithCoupon)
};
```

<br>

**é©—è­‰å™¨**

<br>

C:\91APP\NineYi.Sms\CrossLayer\Validators\PromotionEngines\PromotionEngineBaseValidator.cs

<br>

```csharp
//// ä½”é¡
this.RuleFor(promotionEngineBase => promotionEngineBase.Quota)
       .GreaterThanOrEqualTo(0)
       .WithMessage($"å›é¥‹æ¬¡æ•¸ä¸Šé™ 1-{MaxQuota}æ¬¡")
       .LessThanOrEqualTo(MaxQuota)
       .WithMessage($"å›é¥‹æ¬¡æ•¸ä¸Šé™ 1-{MaxQuota}æ¬¡");
```

<br>

#### 2.1.6 å›ºå®šçµ¦é»ä¸Šé™

**æ—¢æœ‰è¨­å®š**

<br>

PromotionEngineCreateEntity.RewardPointRuleList.MaxRewardPoint

<br>

```csharp
/// <summary>
/// çµ¦é»ä¸Šé™
/// </summary>
public decimal? MaxRewardPoint { get; set; }
```

<br>

**æª”æ¡ˆä½ç½®**

<br>

- C:\91APP\NineYi.Sms\BusinessLogic\BE\Nine1Promotions\Requests\CreatePromotionRequestEntity.cs
- CreatePromotionRequestEntity.RewardPointRuleList

<br>

**é©—è­‰å™¨**

<br>

```csharp
//// å›ºå®šçµ¦é»é©—è­‰
this.When(
    promotionEngineBase => promotionEngineBase.TypeDef == nameof(PromotionConditionTypeEnum.RewardReachPriceWithPoint2),
    () =>
    {
        //// é©—è­‰çµ¦é»ä¸Šé™è¨­å®šå€¼
        this.When(
           promotion => promotion.RewardPointRuleList != null,
           () =>
           {
               this.RuleFor(promotion => promotion.RewardPointRuleList)
                   .Must(ruleList => ruleList.All(rule => rule.MaxRewardPoint == null || (rule.MaxRewardPoint % 1 == 0 && rule.MaxRewardPoint is >= 0 and <= MaxRewardPointsLimit)))
                   .WithMessage($"é»æ•¸ä¸Šé™ç‚º {MaxRewardPointsLimit}");
           });
    });
```

<br>

```csharp
/// <summary>
/// çµ¦é»ä¸Šé™
/// </summary>
private const int MaxRewardPointsLimit = 9_999_999;
```

<br>

#### 2.1.7 çµ¦åˆ¸ä¸Šé™

**æª”æ¡ˆä½ç½®**

<br>

- C:\91APP\NineYi.Sms\BusinessLogic\BE\PromotionEngines\PromotionEngineCreateEntity.cs
- PromotionEngineCreateEntity.RewardCouponRuleList
- C:\91APP\NineYi.Sms\BusinessLogic\BE\Promotions\PromotionRewardCouponRuleEntity.cs

<br>

**é©—è­‰å™¨**

<br>

```csharp
//// é©—è­‰çµ¦åˆ¸ä¸Šé™çš„è¨­å®šå€¼
this.When(
   promotion => promotion.RewardCouponRuleList != null,
   () =>
   {
       this.RuleFor(promotion => promotion.RewardCouponRuleList)
               .Must(ruleList => ruleList.All(rule => rule.MaxRewardCouponQty == null || (rule.MaxRewardCouponQty is > 0 and <= MaxRewardCouponQtyLimit)))
               .WithMessage($"å¼µæ•¸ä¸Šé™ç‚º {MaxRewardCouponQtyLimit}");
   });
```

<br>

#### 2.1.8 æ°¸ä¹…æ•ˆæœŸ

**æª”æ¡ˆä½ç½®**

<br>

- C:\91APP\NineYi.Sms\BusinessLogic\BE\PromotionEngines\PromotionEngineCreateEntity.cs
- PromotionEngineCreateEntity.PeriodType
- PromotionRewardPointPeriodTypeEnum

<br>

### 2.2 GET API

#### 2.2.1 æ–°èˆŠç‰ˆ API

**æ–°ç‰ˆ API**

<br>

https://sms.qa1.hk.91dev.tw/Api/PromotionEngine/GetPromotionEngineDetail?promotionEngineId=5914&promotionEngineTypeDef=RewardReachPriceWithRatePoint2&shopId=2

<br>

**èˆŠç‰ˆ API**

<br>

https://sms.qa1.hk.91dev.tw/Api/PromotionEngine/GetPromotionRewardPointDetail?promotionEngineId=5915

<br>

### 2.3 Update API

#### 2.3.1 URL

https://sms.qa1.hk.91dev.tw/Api/PromotionEngine/UpdatePromotionEngine

<br>

#### 2.3.2 èˆŠæ´»å‹• API

https://sms.qa1.hk.91dev.tw/Api/PromotionEngine/UpdatePromotionRewardPoint

<br>

#### 2.3.3 æ–™è™Ÿé™åˆ¶

**æ–™è™Ÿ**ï¼š100,000

<br>

**åºè™Ÿ**ï¼š500,000

<br>

### 2.4 DELETE API

#### 2.4.1 URL

https://sms.qa1.hk.91dev.tw/Api/PromotionEngine/DeletePromotionRewardPoint

<br>

### 2.5 COPY API

#### 2.5.1 URL

**æ–° API**

<br>

https://store.91app.hk/Api/PromotionEngine/GetPromotionEngineReplicant

<br>

https://sms.qa1.hk.91dev.tw/Api/PromotionEngine/GetPromotionEngineReplicant

<br>

### 2.6 æ–™è™Ÿæ•¸é‡

#### 2.6.1 URL

/api/promotion-rules/productsku-outerid-count

<br>

### 2.7 æª¢æŸ¥å•†å“æ´»å‹•

CheckPromotionRewardPointWithSalePage

<br>

### 2.8 å–å¾—å•†å“é æ•¸é‡

GetSalePageListForPromotionEngine

<br>

### 2.9 å–å¾—æ–™è™Ÿæ•¸é‡

GetProductSkuOuterIdList

<br>

### 2.10 åˆ—è¡¨é 

[csp_GetPromotionEngineRewardPointData]

<br>

**çµ¦åˆ¸**

<br>

Api/PromotionReward/GetList

<br>

**çµ¦é»**

<br>

Api/PromotionEngine/GetPromotionRewardPointList

<br>

å·®åœ¨ searchType

<br>

```sql
SET NOCOUNT ON;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

DECLARE @searchTypeList varchar(200) = 'RewardReachPriceWithPoint,RewardReachPriceWithRatePoint,RewardReachPriceWithPoint2,RewardReachPriceWithRatePoint2'

IF @targetMemberTypeDef = 'None' ---- æ–°ç‰ˆæŠ˜æ‰£æ´»å‹•ä¸ä½¿ç”¨Noneä¾†åˆ¤æ–·ç›®æ¨™æœƒå“¡é¡å‹ï¼ŒNoneç­‰åŒæ–¼ä¸ç¯©é¸æ­¤æ¢ä»¶
BEGIN
    SET @targetMemberTypeDef = NULL;
END

IF @targetTypeDef = 'PromotionSalePage'
BEGIN
    SET @targetTypeDef = 'SalePage'; ---- ç›®æ¨™é¡å‹ç‚ºå•†å“é  èˆŠç‰ˆé¡å‹ï¼šPromotionSalePage / æ–°ç‰ˆé¡å‹ï¼šSalePage
END

IF @searchType = 'PromotionReward'
BEGIN
    SET @searchTypeList = 'RewardReachPriceWithCoupon';
END
ELSE
BEGIN
    SET @searchTypeList = 'RewardReachPriceWithPoint,RewardReachPriceWithRatePoint,RewardReachPriceWithPoint2,RewardReachPriceWithRatePoint2';
END
```

<br>

### 2.11 Mapper

```csharp
this.CreateMap<GetPromotionResponseEntity, PromotionEngineUpdateEntity>()
this.CreateMap<PromotionEngineUpdateEntity, PromotionEngineCreateEntity>()
```

<br>