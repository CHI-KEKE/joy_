# 後台文件

## 目錄
1. [促購後台](#1-促購後台)
2. [OSM API](#2-osm-api)

<br>

---

## 1. 促購後台

### 1.1 共用資訊

**Endpoint**：api/promotion-rules

<br>

**位置**：C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\Web\Nine1.Promotion.Web.Api\Controllers\PromotionEngineController.cs

<br>

**活動類型定義**

<br>

- 新版給點活動類型：RewardReachPriceWithPoint2, RewardReachPriceWithRatePoint2
- 新版給券活動類型：RewardReachPriceWithCoupon

<br>

### 1.2 MemberCollection

確認白名單設定

<br>

活動對象為全店則需指定 MemberCollectionId = -1

<br>

```csharp
//// 允許指定客群活動類型，且活動對象為全店，則將MemberCollectionId設為-1(不指定)，其餘空值為不支援
if (entity.TargetMemberTypeDef == nameof(PromotionEngineTargetMemberTypeDefEnum.All) &&
            this._enableMemberCollectionPromotionType.Contains(entity.TypeDef))
{
     entity.MemberCollectionId = "-1";
}
```

<br>

請參考目前已實作支援客群的活動類型：DiscountByMemberWithPrice

<br>

by 環境設定是否走新版 MemberCollection 開關

<br>

- Table：ShopStaticSetting
- Group：PromotionEngine
- Key：SupportMemberCollectionShop

<br>

範例：HK_QA：2|none，前面為白名單，後面是黑名單

<br>

程式碼流程中，儲存時需確認相關 DB 欄位正確設定儲存

<br>

- PromotionEngine_TargetMemberTypeDef = MemberCollection
- PromotionEngine_UpdatedUser = SyncPromotionTagToCollection
- PromotionEngine_DisplaySetting = Member / All ??
- PromotionEngine_MemberCollectionId = 93be0653-4a61-4d8d-9a24-530d992675fa(範例)(entity.MemberCollectionId ?? string.Empty;)

<br>

確認設定 Rule 的部分

<br>

```csharp
//// 設定活動對象範圍
ruleService.SetMatchedUserScopes(entity.TargetMemberType, entity.CrmShopMemberCardIds, entity.MemberCollectionId);
```

<br>

### 1.3 GET API

#### 1.3.1 URL

url：/api/promotion-rules/get

<br>

#### 1.3.2 點數永久效期

🔍 檔案

<br>

C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngineRules\RewardReachPriceWithPoint2RuleService.cs

<br>

🗂️ 方法

<br>

ParsePromotionEngineRuleObject

<br>

#### 1.3.3 TG 上限

🔍 檔案

<br>

C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngineRules\RewardReachPriceWithPoint2RuleService.cs

<br>

🗂️ 方法

<br>

ParsePromotionEngineRuleObject

<br>

#### 1.3.4 佔額

🔍 檔案

<br>

- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngines\PromotionEngineService.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngineRules\IPromotionEngineRuleService.cs

<br>

**流程**

<br>

```csharp
/// 佔額
if (PromotionEngineHelper.IsQuotaSupportedPromotionTypes(result.TypeDef))
{
    result.Quota = ruleService.GetCustomField2ToEntity<int>(promotionEngineSetting.PromotionEngineSetting_CustomField2, 0);
}
```

<br>

PromotionEngineSetting_CustomField2

<br>

實作 T GetCustomField2ToEntity<T>(string customField2, T defaultValue);

<br>

```csharp
/// <summary>
/// 取得自訂規則 2
/// </summary>
/// <param name="customField2">PromotionEngineSetting_CustomField2</param>
/// <param name="defaultValue">預設值</param>
/// <returns>T</returns>
public override T GetCustomField2ToEntity<T>(string customField2, T defaultValue)
{
    var splitCustomField = customField2.Split(":");
    if (string.IsNullOrEmpty(customField2) || splitCustomField == null || splitCustomField.Length < 1)
    {
        return defaultValue;
    }

    return (T)Convert.ChangeType(splitCustomField[1], typeof(T));
}
```

<br>

### 1.4 Update API

#### 1.4.1 URL

api/promotion-rules/update

<br>

#### 1.4.2 UpdatePromotionRequestEntity 說明

C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.BE\Promotions\Requests\UpdatePromotionRequestEntity.cs

<br>

✅ **用途**

<br>

UpdatePromotionRequestEntity 是更新促銷活動時使用的 API 請求物件，完整承載一筆促銷活動的所有設定，供後端進行：

<br>

- 欄位驗證
- 與資料庫比對
- 寫入更新
- 執行促銷邏輯

<br>

**繼承來源**：PromotionBaseEntity → 因此自動包含所有活動的共通欄位屬性

<br>

🔑 **主要結構**

<br>

**1️⃣ 共通欄位 (PromotionBaseEntity)**

<br>

| 欄位名稱 | 說明 |
|----------|------|
| ShopId | 商店序號，代表活動所屬店家 |
| Id | 活動唯一序號，更新時必填 |
| Name | 活動名稱 |
| Description | 活動描述 |
| TypeDef | 活動折扣類型，對應促銷邏輯 |
| StartDateTime / EndDateTime | 活動期間 |
| IsRegular | 是否為常態活動 |
| HasPicture | 活動是否包含圖片 |
| Terms / AgreeContent | 活動條款與同意內容 |

<br>

**2️⃣ 🧩 目標對象設定**

<br>

| 欄位名稱 | 說明 |
|----------|------|
| TargetMemberType / TargetMemberTypeDef | 目標會員類型（如所有會員、VIP） |
| CrmShopMemberCardIds | 指定會員卡等級 ID 清單 |
| PromotionTargetRegionType | 配送區域範圍（全區/分區） |
| IncludeTargetRegionIdList | 指定配送區域清單 |
| TargetLocationType | 門市範圍類型（全店/部分門市） |
| IncludeTargetLocationIdList | 指定門市 ID |
| TargetPlatformTypeList | 適用通路類型（官網/APP 等） |

<br>

**3️⃣ 🏷️ 指定 / 排除商品範圍**

<br>

| 欄位名稱 | 說明 |
|----------|------|
| TargetType / TargetTypeDef | 活動適用範圍（如全店、指定商品） |
| IncludeTargetIdList | 指定的商品或分類 ID 清單 |
| IncludeProductSkuOuterIdList | 指定商品 SKU（外部編號） |
| ExcludeTargetIdList | 排除的商品 ID 清單 |
| ExcludeProductSkuOuterIdList | 排除的 SKU 清單 |

<br>

**4️⃣ 🛍️ 促銷規則**

<br>

| 欄位名稱 | 說明 |
|----------|------|
| DiscountRuleList | 折抵規則（滿額折抵） |
| GiftRuleList | 贈品規則（滿額贈品） |
| AddOnsRuleList | 加價購商品設定 |
| IsCyclable | 是否循環執行 |
| Accumulated | 是否累贈（累積多次） |
| IsMultiLevel | 是否多階層設定 |
| CanUseECoupon | 是否可與折價券併用 |
| CalculateTypeDef | 與其他活動計算邏輯 |

<br>

**5️⃣ 🎁 給點 / 給券**

<br>

| 欄位名稱 | 說明 |
|----------|------|
| RewardPointConditions | 舊版給點條件（已標記 Obsolete） |
| RewardConditions | 新版給點條件 |
| RewardPointRuleList | 給點規則清單（滿額給點細節） |
| RewardCouponRuleList | 給券規則清單 |
| PeriodType | 點數效期設定 |
| PromotionRewardPointCalculateTypeDef | 點數計算方式（百分比、固定值等） |

<br>

**6️⃣ 📦 其他設定**

<br>

| 欄位名稱 | 說明 |
|----------|------|
| IsDisplayInShoppingCart | 是否在購物車顯示活動訊息 |
| IsAddOnsThresholdEligible | 加購品是否可作為滿額門檻 |
| PayTypes / ShippingTypes | 限定的付款 / 配送方式 |
| Label | 活動標籤 |
| UpdatedUser / UpdatedDateTime | 更新者與更新時間 |
| IsNeedRecordIo | 是否需要記錄歷程（I/O） |
| Sort | 排序順序 |

<br>

#### 1.4.3 佔額

C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngines\PromotionEngineService.cs

<br>

```csharp
//// 支援佔額的活動類型, 0 表示不限次數
if (PromotionEngineHelper.IsQuotaSupportedPromotionTypes(updateRequest.TypeDef))
{
    originSetting.PromotionEngineSetting_CustomField2 = $"{nameof(updateRequest.Quota)}:{updateRequest.Quota}";
}
```

<br>

#### 1.4.4 永久效期

Create 寫過就好了

<br>

#### 1.4.5 TG 上限

Create 新增即可

<br>

#### 1.4.6 活動進行中不能改的欄位

通路

<br>

### 1.5 CREATE API

#### 1.5.1 URL

/api/promotion-rules/create

<br>

#### 1.5.2 回饋點數上限

已知目前新版依比例給點活動類型 (RewardReachPriceWithRatePoint2) 已實作，請參考該作法實作在新版固定給點活動類型 (RewardReachPriceWithPoint2)

<br>

需考量到新舊相容 (預設值應該是多少)

<br>

資料會從 PromotionBaseEntity.RewardPointRule.MaxRewardPoint 節點傳入 Controller

<br>

促購引擎需修改 RewardReachPriceWithPointThreshold 加上 MaximumPoints (參考 RewardReachPriceWithRatePointThreshold)

<br>

ParsePromotionEngineRuleObject 時需從 threshold 正確 mapping MaxRewardPoint 出來讓 PromotionEngine_Rule 可以存取

<br>

需於驗證器 PromotionBaseValidator 針對 MaximumPoints 實作以下規則：

<br>

- 僅可輸入半形數字
- 給點上限不得小於固定給點的點數 (僅固定給點檢核)：須大於單次回饋的點數
- 點數上限為 9,999,999，輸入超過的錯誤訊息：點數上限為 9,999,999

<br>

**參考檔案**

<br>

C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngineRules\RewardReachPriceWithRatePoint2RuleService.cs

<br>

**實作檔案**

<br>

C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngineRules\RewardReachPriceWithPoint2RuleService.cs

<br>

#### 1.5.3 永久效期

PromotionRewardPointPeriodTypeEnum 需新增 enum Permanent 表示該活動回饋的點數為永久效期

<br>

前端會從節點 CreatePromotionRequestEntity.PeriodType.RewardPointPeriodType 傳入

<br>

對應的活動類型的 RuleService 需要在 GetPromotionEngineRule 方法中 Parse 並處理該 Enum 到 PointUntil

<br>

資料可以放在 PromotionEngineRuleEntity.PeriodType 中，存入 PromotionEngine_Rule

<br>

**檔案位置**

<br>

- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.BE\Promotions\Requests\CreatePromotionRequestEntity.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.BE\Promotions\PromotionBaseEntity.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\Common\Nine1.Promotion.Common.Validators\Promotions\PromotionBaseValidator.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.BE\Promotions\PromotionRewardPointPeriodTypeEntity.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.BE\Promotions\Enums\PromotionRewardPointPeriodTypeEnum.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngines\PromotionEngineService.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngineRules\RewardReachPriceWithPoint2RuleService.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngineRules\RewardReachPriceWithRatePoint2RuleService.cs

<br>

#### 1.5.4 佔額

需新增 MaxRewardTimesPerMember 節點取得前端的佔額數字並儲存 (要對齊站額的 api 名稱)

<br>

節點要包一個 entity 嗎

<br>

**PromotionEngineSetting Table**

<br>

- Table：PromotionEngineSetting
- Column：PromotionEngineSetting_CustomField2

<br>

**驗證器 (PromotionBaseEntity)**

<br>

- 上限Ｎ次（預設此選項），若選此項，則Ｎ為必填寫
- 此Ｎ欄位最多輸入 1-30，若輸入非半形數字，需要出現錯誤訊息：請輸入半形數字
- 無上限
- 新舊相容 (舊的活動沒有佔額概念，編輯時要確保給預設值，但預設值是 N 次，要定義清楚多少)

<br>

**參考檔案**

<br>

- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.BE\Promotions\PromotionBaseEntity.cs
- C:\91APP\Promotion\webapi\nine1.promotion.web.api\src\BusinessLogic\Nine1.Promotion.BL.Services\PromotionEngines\PromotionEngineService.cs

<br>

### 1.6 Parse Scopes

**Item1：productScopePairs**

<br>

- includedScopes：IncludedProductScopes,TagId
- excludedScopes：ExcludedProductScopes,TagId

<br>

**Item2：userScopePairs**

<br>

- MatchedUserScopes
- VisibleUserScopes

<br>

**Item3：rewardPointRules**

<br>

**Item4：rewardPointPeriodType**

<br>

**Item5：calculateTypeDef**

<br>

**Item6：locationScopePairs**

<br>

- IncludedLocationScopes：IncludedLocationScopes,TagId

<br>

### 1.7 matchedSalesChannels

```json
"matchedSalesChannels": [
    "Web",
    "AppIOS",
    "AppAndroid",
    "LocationWizard",
    "InStore"
]
```

<br>

s3 的 rule 節點有個 "MatchedSalesChannels":31

<br>

```csharp
[Flags]
public enum SalesChannelEnum
{
    Web = 1,
    AppIOS = 2,
    AppAndroid = 4,
    LocationWizard = 8,
    InStore = 0x10
}
```

<br>

### 1.8 料號數量

productsku-outerid-count

<br>

### 1.9 匯出料號清單

productsku-outerid-list

<br>

### 1.10 異動料號

<br>

### 1.11 測試資料

**商品**：[61284,61361,61296]

<br>

**料號**：["aaa","zzz"]

<br>

Collection:f_278806561465963776

<br>

OuterIdTag:5022

<br>

==> ProductScopeType NineYi.Msa.Promotion.Engine.AllProductScope

<br>

location tag 5023

<br>

---

## 2. OSM API

### 2.1 CREATE API

#### 2.1.1 關鍵字

"Create"

<br>

#### 2.1.2 舊活動適用門市 API

https://sms.qa1.hk.91dev.tw/Api/Location/GetListForAll

<br>

#### 2.1.3 OSM 活動新增 API

https://sms.qa1.hk.91dev.tw/Api/PromotionEngine/Create

<br>

#### 2.1.4 料號限制

**序號**：10,000

<br>

**料號**：10,000

<br>

#### 2.1.5 佔額

**檔案位置**

<br>

- BusinessLogic/BE/PromotionEngines/PromotionEngineBaseEntity.cs
- BusinessLogic/BE/Nine1Promotions/Requests/CreatePromotionRequestEntity.cs  
- BusinessLogic/Services/PromotionEngines/PromotionEngineService.cs

<br>

```csharp
/// <summary>
/// 佔額 (會員回饋次數上限)
/// 0 : 不限次數
/// </summary>
public int Quota { get; set; }
```

<br>

```csharp
this._quotaSupportedPromotionTypeList = new List<string>
{
    nameof(PromotionEngineTypeDefEnum.RewardReachPriceWithPoint2),
    nameof(PromotionEngineTypeDefEnum.RewardReachPriceWithRatePoint2),
    nameof(PromotionEngineTypeDefEnum.RewardReachPriceWithCoupon)
};
```

<br>

**驗證器**

<br>

C:\91APP\NineYi.Sms\CrossLayer\Validators\PromotionEngines\PromotionEngineBaseValidator.cs

<br>

```csharp
//// 佔額
this.RuleFor(promotionEngineBase => promotionEngineBase.Quota)
       .GreaterThanOrEqualTo(0)
       .WithMessage($"回饋次數上限 1-{MaxQuota}次")
       .LessThanOrEqualTo(MaxQuota)
       .WithMessage($"回饋次數上限 1-{MaxQuota}次");
```

<br>

#### 2.1.6 固定給點上限

**既有設定**

<br>

PromotionEngineCreateEntity.RewardPointRuleList.MaxRewardPoint

<br>

```csharp
/// <summary>
/// 給點上限
/// </summary>
public decimal? MaxRewardPoint { get; set; }
```

<br>

**檔案位置**

<br>

- C:\91APP\NineYi.Sms\BusinessLogic\BE\Nine1Promotions\Requests\CreatePromotionRequestEntity.cs
- CreatePromotionRequestEntity.RewardPointRuleList

<br>

**驗證器**

<br>

```csharp
//// 固定給點驗證
this.When(
    promotionEngineBase => promotionEngineBase.TypeDef == nameof(PromotionConditionTypeEnum.RewardReachPriceWithPoint2),
    () =>
    {
        //// 驗證給點上限設定值
        this.When(
           promotion => promotion.RewardPointRuleList != null,
           () =>
           {
               this.RuleFor(promotion => promotion.RewardPointRuleList)
                   .Must(ruleList => ruleList.All(rule => rule.MaxRewardPoint == null || (rule.MaxRewardPoint % 1 == 0 && rule.MaxRewardPoint is >= 0 and <= MaxRewardPointsLimit)))
                   .WithMessage($"點數上限為 {MaxRewardPointsLimit}");
           });
    });
```

<br>

```csharp
/// <summary>
/// 給點上限
/// </summary>
private const int MaxRewardPointsLimit = 9_999_999;
```

<br>

#### 2.1.7 給券上限

**檔案位置**

<br>

- C:\91APP\NineYi.Sms\BusinessLogic\BE\PromotionEngines\PromotionEngineCreateEntity.cs
- PromotionEngineCreateEntity.RewardCouponRuleList
- C:\91APP\NineYi.Sms\BusinessLogic\BE\Promotions\PromotionRewardCouponRuleEntity.cs

<br>

**驗證器**

<br>

```csharp
//// 驗證給券上限的設定值
this.When(
   promotion => promotion.RewardCouponRuleList != null,
   () =>
   {
       this.RuleFor(promotion => promotion.RewardCouponRuleList)
               .Must(ruleList => ruleList.All(rule => rule.MaxRewardCouponQty == null || (rule.MaxRewardCouponQty is > 0 and <= MaxRewardCouponQtyLimit)))
               .WithMessage($"張數上限為 {MaxRewardCouponQtyLimit}");
   });
```

<br>

#### 2.1.8 永久效期

**檔案位置**

<br>

- C:\91APP\NineYi.Sms\BusinessLogic\BE\PromotionEngines\PromotionEngineCreateEntity.cs
- PromotionEngineCreateEntity.PeriodType
- PromotionRewardPointPeriodTypeEnum

<br>

### 2.2 GET API

#### 2.2.1 新舊版 API

**新版 API**

<br>

https://sms.qa1.hk.91dev.tw/Api/PromotionEngine/GetPromotionEngineDetail?promotionEngineId=5914&promotionEngineTypeDef=RewardReachPriceWithRatePoint2&shopId=2

<br>

**舊版 API**

<br>

https://sms.qa1.hk.91dev.tw/Api/PromotionEngine/GetPromotionRewardPointDetail?promotionEngineId=5915

<br>

### 2.3 Update API

#### 2.3.1 URL

https://sms.qa1.hk.91dev.tw/Api/PromotionEngine/UpdatePromotionEngine

<br>

#### 2.3.2 舊活動 API

https://sms.qa1.hk.91dev.tw/Api/PromotionEngine/UpdatePromotionRewardPoint

<br>

#### 2.3.3 料號限制

**料號**：100,000

<br>

**序號**：500,000

<br>

### 2.4 DELETE API

#### 2.4.1 URL

https://sms.qa1.hk.91dev.tw/Api/PromotionEngine/DeletePromotionRewardPoint

<br>

### 2.5 COPY API

#### 2.5.1 URL

**新 API**

<br>

https://store.91app.hk/Api/PromotionEngine/GetPromotionEngineReplicant

<br>

https://sms.qa1.hk.91dev.tw/Api/PromotionEngine/GetPromotionEngineReplicant

<br>

### 2.6 料號數量

#### 2.6.1 URL

/api/promotion-rules/productsku-outerid-count

<br>

### 2.7 檢查商品活動

CheckPromotionRewardPointWithSalePage

<br>

### 2.8 取得商品頁數量

GetSalePageListForPromotionEngine

<br>

### 2.9 取得料號數量

GetProductSkuOuterIdList

<br>

### 2.10 列表頁

[csp_GetPromotionEngineRewardPointData]

<br>

**給券**

<br>

Api/PromotionReward/GetList

<br>

**給點**

<br>

Api/PromotionEngine/GetPromotionRewardPointList

<br>

差在 searchType

<br>

```sql
SET NOCOUNT ON;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

DECLARE @searchTypeList varchar(200) = 'RewardReachPriceWithPoint,RewardReachPriceWithRatePoint,RewardReachPriceWithPoint2,RewardReachPriceWithRatePoint2'

IF @targetMemberTypeDef = 'None' ---- 新版折扣活動不使用None來判斷目標會員類型，None等同於不篩選此條件
BEGIN
    SET @targetMemberTypeDef = NULL;
END

IF @targetTypeDef = 'PromotionSalePage'
BEGIN
    SET @targetTypeDef = 'SalePage'; ---- 目標類型為商品頁 舊版類型：PromotionSalePage / 新版類型：SalePage
END

IF @searchType = 'PromotionReward'
BEGIN
    SET @searchTypeList = 'RewardReachPriceWithCoupon';
END
ELSE
BEGIN
    SET @searchTypeList = 'RewardReachPriceWithPoint,RewardReachPriceWithRatePoint,RewardReachPriceWithPoint2,RewardReachPriceWithRatePoint2';
END
```

<br>

### 2.11 Mapper

```csharp
this.CreateMap<GetPromotionResponseEntity, PromotionEngineUpdateEntity>()
this.CreateMap<PromotionEngineUpdateEntity, PromotionEngineCreateEntity>()
```

<br>