# 規則文件

## 目錄
1. [適用商品](#1-適用商品)
2. [門市](#2-門市)
3. [會員卡等級](#3-會員卡等級)
4. [通路](#4-通路)
5. [料號](#5-料號)
6. [活動類型](#6-活動類型)
7. [Thresholds門檻定義](#7-thresholds門檻定義)

<br>

---

## 1. 適用商品

### 1.1 TargetType 判斷表格

| TargetType | ExcludeTargetType | 說明 |
|------------|-------------------|------|
| Shop | None | 全店活動 / 不排除 |
| Shop | SalePage | 全店活動 / 有排除 |
| SalePage | None | 指定商品或料號 |

<br>

### 1.2 設定ProductScopes 跑進來的 Collection 長相

![alt text](./image-3.png)

<br>

---

## 2. 門市

**TargetLocationTypeDef**

<br>

- 所有門市 (All)：All
- 指定門市 (Location)：Location

<br>

**IncludeTargetLocationIdList**

<br>

- 所有 (All)：[] (空陣列)
- 指定門市 (Location)：門市 Ids

<br>

**PromotionTargetLocationTypeDefEnum**

<br>

- 所有門市 = All
- 指定門市 = Location

<br>

**PromotionEngine**

<br>

PromotionEngine_TargetLocationTypeDef：活動門市類型

<br>

**PromotionTag**

<br>

PromotionTagId：每個 LocationId 對應一個 PromotionTagSlave_TargetTypeId = targetId

<br>

**Rule**

<br>

includedLocationScopes

<br>

- TargetLocationType = All → LocationScopeType = AllLocationScope
- TargetLocationType = Location → TagLocationScope = LocationScopeType + TagId

<br>

---

## 3. 會員卡等級

Query CrmShopMemberCard

<br>

---

## 4. 通路

SMS 使用 ChannelType 溝通通路，促購後台拆解如下

<br>

| 通路類型 | Web | AppAndroid | AppIOS | LocationWizard | InStore |
|---------|-----|------------|--------|----------------|---------|
| APP/官網/門市 (All) | ✓ | ✓ | ✓ | ✓ | ✓ |
| APP/門市 (AppAndInStore) |  | ✓ | ✓ | ✓ | ✓ |
| APP (App) |  | ✓ | ✓ |  |  |
| 官網/App (WebAndApp) | ✓ | ✓ | ✓ |  |  |
| 門市 (InStore) |  |  |  | ✓ | ✓ |

<br>

**PromotionEnginePlatformTypeEnum(DB) / SalesChannelEnum(RuleRecord)**

<br>

- Web (官網)
- AppIOS (iOS)
- AppAndroid (Android)
- LocationWizard (店員幫手)
- InStore (門市)

<br>

**儲存方式**

<br>

GetPlatformTypeDiction

<br>

**適用**

<br>

- isWeb
- isAndroid
- isiOS
- isInStore
- isLocationWizard

<br>

**可見**

<br>

- isWebVisible
- isAndroidVisible
- isiOSVisible
- isLocationWizardVisible

<br>

**PromotionEngineSetting**

<br>

適用：

<br>

- PromotionEngineSetting_IsWeb
- PromotionEngineSetting_IsAndroidApp
- PromotionEngineSetting_IsiOSApp
- PromotionEngineSetting_IsLocationWizard
- PromotionEngineSetting_IsInStore

<br>

可見：

<br>

- PromotionEngineSetting_IsWebVisible
- PromotionEngineSetting_IsAndroidAppVisible
- PromotionEngineSetting_IsiOSAppVisible
- PromotionEngineSetting_IsLocationWizardVisible

<br>

**PromotionEngine Rule**

<br>

- MatchedSalesChannels：TargetPlatformTypeList
- VisibleSalesChannels：VisiblePlatformTypeList

<br>

**類型 (Type)**

<br>

- Web
- AppIOS
- AppAndroid
- LocationWizard
- InStore

<br>

**可視通路邏輯**

<br>

有 APP：

<br>

- isWebVisible
- isAndroidVisible
- isiOSVisible

<br>

門市：

<br>

- isWebVisible
- isLocationWizardVisible
- isAndroidVisible
- isiOSVisible

<br>

---

## 5. 料號

**關鍵字**

<br>

- OuterIdTagConstants
- PromotionProductSkuOuterIdModifyTypeDefEnum
- ModifyPromotionProductSkuOuterIds
- UpdateExcludeProductSkuIdScopes
- CreatePromotionSlaveTagForTargetTypeCode

<br>

**解析 OuterTagId**

<br>

```csharp
var ruleService = this.GetRuleService(promotion.PromotionEngine_TypeDef);

//// 反序列化Rule
var ruleEntity = ruleService.ParsePromotionEngineRuleObject(promotion.PromotionEngine_Rule);

ruleEntity.ProductScopes;

var outerIdTags = result.ProductScopes?.Where(a => a.Value.IsFullOuterIdTag()).Select(a => a.Value).ToList();
var outerIdTag = outerIdTags.FirstOrDefault();
if (outerIdTag != null)
{
    result.TargetTypeProductSkuOuterIdTag = outerIdTag;
    if (long.TryParse(outerIdTag.GetTagIdWithOuterIdTag(), out long promotionTagId))
        var tagSlaveCount = this._promotionEngineRepository.GetPromotionTagSlaveCount(promotionTagId, nameof(PromotionTagSlaveTargetTypeDefEnum.SalePage));
        var tagSlaveList = this._promotionEngineRepository.GetPromotionTagSlaveList(promotionTagId, nameof(PromotionTagSlaveTargetTypeDefEnum.SalePage)).ToList();
        var outerIds = tagSlaveList.Select(p => p.PromotionTagSlave_TargetTypeCode).ToList();
}
```

<br>

**限制**

<br>

關鍵字：OuterId / ProductSkuOuterId

<br>

- 每個料號字元上限：30
- 批次作業 EXCEL 行數限制：500 (對應 500 檔活動)
- UI 介面每次圈選數量：500
- 批次料號每筆限制：5000 (by promotion)
- 每個活動料號上限：100000
- 批次更新活動料號 BatchUploadType：BatchModifyPromotionOuterId
- 料號檢查：僅接受英數字 / 重複料號
- 新增料號數量限制：10000
- 編輯最高數量限制：100000

<br>

**商品頁 / 料號 / Tag 資料儲存關係**

<br>

- 商品頁：PromotionTagSlave_TargetTypeId = targetId
- 料號：PromotionTagSlave_TargetTypeCode = productSkuCode

<br>

**舊 PromotionTag 邏輯**

<br>

使用檔案上傳實作

<br>

---

## 6. 活動類型

- RewardReachPriceWithRatePoint2
- RewardReachPriceWithPoint2
- RewardReachPriceWithCoupon
- DiscountReachPriceWithFreeGift

<br>

---

## 7. Thresholds門檻定義

**指定客群給券**

<br>

```json
"Thresholds": {
  "AllUserScope": {
    "ReachPriceCouponPairs": [
      {
        "ReachPrice": 1.0,
        "Coupons": [
          {
            "Id": "2702",
            "Qty": 1
          }
        ]
      }
    ],
    "MaximumCouponQty": null
  }
}
```

<br>

**會員等級**

<br>

```json
"Thresholds": {
  "CrmShopMemberCard:5": {
    "ReachPriceCouponPairs": [
      {
        "ReachPrice": 100.0,
        "Coupons": [
          {
            "Id": "2212",
            "Qty": 1
          }
        ]
      }
    ]
  },
  "CrmShopMemberCard:32": {
    "ReachPriceCouponPairs": [
      {
        "ReachPrice": 100.0,
        "Coupons": [
          {
            "Id": "2212",
            "Qty": 1
          }
        ]
      }
    ]
  }
}
```

<br>