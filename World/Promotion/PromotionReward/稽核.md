# 稽核文件

## 目錄
1. [CheckPromotionRuleRecordJob](#1-checkpromotionrulerecordjob)
2. [BatchAuditLoyaltyPointsJob](#2-batchauditloyaltypointsjob)
3. [AuditPromotionRewardLoyaltyPointsV2Job.cs](#3-auditpromotionrewardloyaltypointsv2jobcs)
4. [AuditCrmOthersOrderPromotionRewardLoyaltyPointsV2Job](#4-auditcrmothersorderpromotionrewardloyaltypointsv2job)
5. [AuditPromotionRewardLoyaltyPointsDispatchV2Job](#5-auditpromotionrewardloyaltypointsdispatchv2job)

<br>

---

## 1. CheckPromotionRuleRecordJob

### 功能

檢查進行中活動的 RuleRecord

<br>

### 參數

**StartDatetime：** 被更新的活動時間區間起始

**EndDatetime：** 被更新的活動時間區間結束

<br>

### 測試資料範例

```json
{"Data":"{\"StartDatetime\":\"2025-03-07T02:00\",\"EndDatetime\":\"2025-03-20T02:45\"}"}
```
<br>

### 檢查範圍

#### 檢查哪些資料

**活動 (PromotionEngine)：** 指定時間區間內 / 活動類型，尚未結束的活動

**規則 (PromotionRuleRecord)：** 取得每檔活動最新一筆規則紀錄

<br>

#### 檢核項目

1. 是否有 RuleRecord
2. 檢查最新的 RuleRecord 是否有 S3 Key
3. 檢查 S3 資料是否存在
4. 解析 ProductScope 取得 OuterIdTag 是否可正常取得 promotionTagId
5. 比對 S3 S3ProductSkuOuterIds 與 PromotionTagSlave_TargetTypeCode

<br>

### 問題處理

檢核到有問題的活動時，因為新增、編輯活動時必定會上傳 S3 產生對應的 Record，若無則視為髒資料，應移除該檔活動，否則將可能造成購物車無法進入的風險。

<br>

---

## 2. BatchAuditLoyaltyPointsJob

### 2.1 AuditRecycleLoyaltyPointsV2Service

#### 訊息案例

**MY環境 Prod 異常訊息範例：**

<br>

```
[MY][Prod]
點數紀錄稽核異常
ServiceName: AuditRecycleLoyaltyPointsV2Service
ShopId: 200017
異常項目:
MS250703M00020A|8354 查無紀錄

點數回收稽核錯誤：DDB 已還點而狀態未更新 IDs：8354_MG250703M00002_MS250703M00020A_0
```

<br>

#### Quick Tips

通常是伴隨 RecycleLoyaltyPointsV2 觸發

<br>

可以先查是否有 RecycleLoyaltyPointsV2 fail 紀錄

<br>

#### 相關邏輯

By 活動Id 取得實際回收點數：

<br>

```
detailEntities.Sum(detail => detail.LoyaltyPoint) - insufficientPoints
```

<br>

#### 檢查是否有 defectDetailList

**訊息：** 點數回收稽核錯誤：DDB 已還點而狀態未更新 IDs

<br>

**邏輯：**
- detail.Status != nameof(RewardDetailStatusEnum.NoReward)
- detail.IsRecycle == false
- detail.Status != nameof(RewardDetailStatusEnum.Recycle) && detail.Status != nameof(RewardDetailStatusEnum.Cancel)

<br>

#### 檢查是否有 defectRecordList

**訊息：** 點數回收稽核錯誤：DDB 發現退點超過給點數量 IDs

<br>

**邏輯：**
- record.GivingPoints < record.RecyclePoints

<br>

#### 檢查是否有 Transactions

檢查項目：
- LoyaltyPointTransactionOccurTypeId
- LoyaltyPointTransactionEventTypeDef
- VipmemberId

<br>

如果沒有 Transaction 就會異常

<br>

---

## 3. AuditPromotionRewardLoyaltyPointsV2Job.cs

### 觸發機制

<br>

由 AuditPromotionRewardLoyaltyPointsDispatchV2Job 觸發，而 AuditPromotionRewardLoyaltyPointsDispatchV2Job 由 Cronjob 依照每小時 01 分觸發

<br>

### 線上訂單稽核邏輯

<br>

AuditPromotionRewardLoyaltyPointsDispatchV2Job 依照執行時間撈取 salesOrderGroup 前 2 小時訂單發動稽核，會檢查 SalesOrderGroup IsValid

<br>

OrderDateTime = salesOrderGroup.SalesOrderGroupDateTime

<br>

SalesOrderSlaves 在稽核也是直接撈 DB

### 餵資料

```PLAINTEXT

//// tw qa
{"Data":"{\"Id\":\"ee932cc0-b476-4cc1-96d5-d7fb1900418c\",\"IdempotencyKey\":\"TG250411L00004\",\"EventName\":\"OrderCreated\",\"EventArgs\":{\"Market\":null,\"ShopId\":5},\"Source\":{\"ShopId\":5,\"PayType\":\"CreditCardOnce_Stripe\",\"TSCount\":1,\"MemberId\":32909,\"CellPhone\":\"88888888\",\"OrderCode\":\"TG250411L00004\",\"UserAgent\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36\",\"CountryCode\":\"852\",\"HttpReferer\":\"https://cccrrrmmm1.shop.qa1.hk.91dev.tw/V2/ShoppingCart/Index?shopId=5\",\"TotalAmount\":200.0,\"CurrencyCode\":\"HKD\",\"OrderDateTime\":\"2025-04-11T02:20:41.7973958+00:00\"},\"SourceType\":\"Orders\",\"SourceKey\":\"TG250411L00004\",\"CreatedAt\":\"2025-04-11T02:20:42.6189354+00:00\"}"}

//// hk qa
{"Data":"{\"FirstTriggerTime\":\"2025-04-11T14:06:20.4337541+08:00\",\"Id\":\"3ab621a0-2c4a-47e5-9c0e-0d86086c9b46\",\"SourceType\":\"Orders\",\"EventName\":\"OrderCreated\",\"IdempotencyKey\":\"TG250411Q00001\",\"Version\":null,\"SourceKey\":\"TG250411Q00001\",\"CreatedAt\":\"2025-04-11T06:05:52.9052972+00:00\",\"EventArgs\":{},\"Source\":{\"ShopId\":2,\"MemberId\":33132,\"OrderCode\":\"TG250411Q00001\",\"TotalAmount\":721000.0,\"CurrencyCode\":\"HKD\",\"OrderDateTime\":\"2025-04-11T14:05:51.7550714+08:00\",\"PayType\":\"CreditCardOnce_Stripe\",\"CellPhone\":\"934565786\"}}"}


```

<br>

### 3.1 Auditor 1 - PromotionRewardLoyaltyPointsRecordAuditor.cs

<br>

用 LoyaltyPromotionRewards 與 auditData 現撈資料比對

<br>

#### 稽核項目

<br>

- 不應中活動
- 應中活動
- 應給點數與實際點數
- 攤提結果不符預期

<br>

---

## 4. AuditCrmOthersOrderPromotionRewardLoyaltyPointsV2Job

### 觸發機制

<br>

跑線下訂單派發時，觸發 PromotionRewardBatchDispatcherV2Job => AuditPromotionRewardLoyaltyPointsDispatchV2JobName

<br>

AuditPromotionRewardLoyaltyPointsDispatchV2JobName 得到 shopId，撈取前一天等級計算訂單發動 AuditCrmOthersOrderPromotionRewardLoyaltyPointsV2Job

<br>

---

## 5. AuditPromotionRewardLoyaltyPointsDispatchV2Job

### 線上訂單

由 Cronjob 依照每小時 01 分觸發

<br>

依照執行時間撈取 salesOrderGroup 前 2 小時訂單發動稽核，會檢查 SalesOrderGroup IsValid

ShopId => salesOrderGroup.ShopId
MemberId => salesOrderGroup.MemberId
OrderCode => salesOrderGroup.TradesOrderGroupCode
OrderDateTime => salesOrderGroup.OrderDateTime

<br>

### 線下訂單

由 PromotionRewardBatchDispatcherV2Job 觸發

ShopId (CrmSalesOrderShopId)
CrmMemberId (CrmSalesOrderCrmMemberId)
CrmSalesOrderId (CrmSalesOrderId)
TradesOrderFinishDatetime (CrmSalesOrderTradesOrderFinishDateTime)

<br>

### 餵資料

```json
{"Data":"{\"ExecuteTime\":\"2025-08-14T02:20:41.7973958+00:00\",\"IsCrmOthersOrder\":true,\"ShopId\":2}"}
{"Data":"{\"ExecuteTime\":\"2025-03-18T11:32\",\"ShopId\":2,\"IsCrmOthersOrder\":true}"}
{"Data":"{\"ExecuteTime\":\"2025-03-18T11:32\",\"ShopId\":2,\"IsCrmOthersOrder\":true}"}
{"ExecuteTime":"2025-04-11T00:01:15.6443120+08:00"}
{"Data":"{\"ExecuteTime\":\"2025-04-11T00:01:15.6443120+08:00\"}"}
```

<br>