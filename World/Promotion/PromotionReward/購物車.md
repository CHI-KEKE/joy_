# è³¼ç‰©è»Šæ–‡ä»¶

## ç›®éŒ„
1. [CartCreate](#1-cartcreate)

<br>

---

## 1. CartCreate

urlï¼šhttps://shop2.shop.qa1.hk.91dev.tw/shopping/api/carts/create?lang=zh-HK&shopId=2

<br>

### 1.1 æ€éº¼åˆ¤æ–·æ´»å‹•æ˜¯å¦æœ‰ä¸­

promotionInfoList

<br>

- isMatchï¼štrue (åˆ¤æ–·è©²å•†å“æ˜¯å¦ä¸­æ´»å‹•)
- lackOfPriceï¼š0 (åˆ¤æ–·å·®å¤šå°‘éŒ¢)

<br>

### 1.2 æµç¨‹ç¸½è¦½

#### 1.2.1 ğŸ—‚ï¸ å‰ç«¯å‚³å…¥çš„æ¬„ä½

sourceï¼š"Web"ï¼Œä¸¦ç”¨ä¾†çµ„å»º CartContext

<br>

| å€å¡Š | æ¬„ä½èªªæ˜ |
|------|----------|
| æœƒå“¡èˆ‡è£ç½®è³‡è¨Š | - MemberId<br>- UnloginId<br>- IsP1Guest<br>- ShopId |
| ä½¿ç”¨è€…è¿½è¹¤ | - UserClientTrack<br>  - Source (ä¾‹å¦‚ "Web")<br>  - Channel<br>  - Device<br>  - Version<br>  - IsMobile |
| æ´»å‹•ä»£ç¢¼ | - PromoCodeDispatch.PromoCode |
| ç€è¦½å™¨è³‡è¨Š | - UserAgent<br>- HttpReferer |
| å•†åº—èˆ‡ä½ç½® | - LocationId |

<br>

#### 1.2.2 ğŸ§© CartCreateProcessorLayers æµç¨‹çµ„æˆ

| Processor | åŠŸèƒ½ |
|-----------|------|
| 1ï¸âƒ£ CartCreateProcessor | - ç”± CartService å‘¼å«ï¼Œæ‰“ Cart ç«™å°çš„ api/carts/create<br>- æœƒå‘¼å« GetCart èˆ‡ CartCalculate è™•ç†æµç¨‹<br>- å›å‚³ CartEntityï¼ŒåŒ…å«æ­£ç¢º PromotionEngineTypeDefEnum |
| 2ï¸âƒ£ ArrangePromotionRuleInfoProcessor | - æ•´ç†ä¿ƒè³¼æ´»å‹•è¦å‰‡è³‡è¨Š<br>- å‘¼å«å‰å°ä¿ƒè³¼ API /api/promotion-rules/list-by-ids<br>- å°‡å›å‚³çµæœ promotionsfromFrontendPromotionAPI èˆ‡ CartEntity.PromotionInfoList åšå°æ‡‰ Mapping<br>- æ´»å‹•è¦å‰‡å°æ‡‰ç¯€é»ï¼š<br>  - PromotionRewardPointRules<br>  - PromotionRewardCouponRules |
| 3ï¸âƒ£ GetSalepagePromotionDisplayTextProcessor | - è™•ç†è³¼ç‰©è»Š P1 å•†å“å¡ä¸Šçš„æ´»å‹•æç¤ºæ–‡æ¡ˆ (Title / Description)<br>- å¯å®¢è£½åŒ–æç¤ºæ–‡æ¡ˆé¡¯ç¤ºèˆ‡æ’åº |

<br>

#### 1.2.3 ğŸ“ é‡é»ç´°ç¯€èªªæ˜

ğŸ”¹ **1ï¸âƒ£ å‘¼å«å‰å°ä¿ƒè³¼ API**

<br>

```csharp
var promotionsfromFrontendPromotionAPI = await _promotionService.GetPromotionsAsync(promotionIds);
```

<br>

å‘¼å« /api/promotion-rules/list-by-ids

<br>

èˆ‡ CartEntity.PromotionInfoList åš Mapping

<br>

å¡å…¥ï¼š

<br>

- PromotionRewardPointRules
- PromotionRewardCouponRules

<br>

ğŸ”¹ **2ï¸âƒ£ æ´»å‹•æ’åºé‚è¼¯**

<br>

è‹¥éœ€è¦å®¢è£½åŒ–æ´»å‹•æ’åºï¼Œä½¿ç”¨ï¼šPromotionTypeComparer

<br>

ğŸ”¹ **3ï¸âƒ£ å•†å“å¡æç¤ºæ–‡æ¡ˆï¼ˆSalepage Promotion Displayï¼‰**

<br>

ä¸»è¦é€²å…¥é»ï¼š

<br>

```csharp
AssignPromotionDisplayText(context.Data);
```

<br>

ä¿®æ”¹ Titleï¼šéœ€å¯¦ä½œå°æ‡‰çš„ GetPromotionTitleText

<br>

ç¯„ä¾‹ï¼š

<br>

```csharp
public string GetPromotionTitleText(CartPromotionInfoEntity promotionInfo)
{
    return "ä½ çš„è‡ªè¨‚æ¨™é¡Œ";
}
```

<br>

ç¯„ä¾‹ï¼šRewardReachPriceWithCouponDisplayService

<br>

ä¿®æ”¹ Descriptionï¼š

<br>

ArrangePromotionDisplayTextAsync æœƒåˆ†åˆ¥è™•ç†ï¼š

<br>

- MatchedPromotion
- MismatchedPromotion

<br>

GetDisplayTypeDescription(promotion, displayTypeEnum).DisplayTypeDescription

<br>

æ˜¯å¦é¡¯ç¤ºï¼šè¦å°‡æ–‡æ¡ˆåŠ åˆ° SalepageDiscountDisplayEntity.DisplayText æ‰èƒ½é¡¯ç¤º

<br>

ç¢ºèªæœ‰å°‡æ´»å‹•é¡å‹åŠ å…¥ _salepageDisplayPromotionType

<br>

è‹¥è¦æ–°å¢æ´»å‹•é¡¯ç¤ºæœå‹™ï¼šéœ€æ–°å¢å°æ‡‰çš„ DisplayService

<br>

ç¯„ä¾‹ï¼šRewardReachPriceWithCouponDisplayService

<br>

**4ï¸âƒ£ æ˜¯å¦é¡¯ç¤ºæ´»å‹•è¦å‰‡**

<br>

æŸ¥ ShopStaticSetting è¨­å®šæ˜¯å¦é¡¯ç¤ºï¼š

<br>

```sql
select *
from ShopStaticSetting(nolock)
where ShopStaticSetting_ValidFlag = 1
  and ShopStaticSetting_GroupName = 'ShoppingCartSalepage'
  and ShopStaticSetting_Key = 'IsSalepagePromotionRule'
```

<br>

HKQA å•†åº—å¤§å¤šè¨­ç‚º FALSE

<br>

ç¯€é»ï¼šSalepageDiscountDisplayEntity.DisplayText

<br>

é–‹é—œï¼šisShowPromotionRuleTask => isShowPromotionRule

<br>

#### 1.2.4 ğŸ—’ï¸ è£œå……ï¼šæ´»å‹•åç¨±é¡¯ç¤º

é è¨­å¤šç‚º promotion.Name

<br>

#### 1.2.5 ğŸ·ï¸ é™„è¨»

è‹¥å¾ŒçºŒè¦æ“´å……æ–°çš„æ´»å‹•å‹æ…‹ï¼Œè¨˜å¾—ï¼š

<br>

- Promotion Engine TypeDef Enum è¦æ­£ç¢ºå°æ‡‰
- API /api/promotion-rules/list-by-ids è¦æœ‰å°æ‡‰è³‡æ–™
- æ–‡æ¡ˆèˆ‡æ’åºè¦åŒæ­¥èª¿æ•´

<br>

#### 1.2.6 ğŸ“‚ éœ€è¦ä¿®æ”¹çš„æª”æ¡ˆ

- PromotionEngineTypeDefEnum.cs
- GetSalepagePromotionDisplayTextProcessor.cs
- PromotionBaseDisplayService.cs
- GetPromotionEngineResponseEntity.cs
- ArrangePromotionRuleInfoProcessor.cs
- ServiceCollectionExtension.cs

<br>

#### 1.2.7 æµç¨‹åœ–

```mermaid
flowchart TD
    A[å‰ç«¯è«‹æ±‚ CartCreate] --> B[çµ„å»º CartContext]
    B --> C{CartCreateProcessorLayers}
    
    C --> D[1ï¸âƒ£ CartCreateProcessor]
    C --> E[2ï¸âƒ£ ArrangePromotionRuleInfoProcessor]
    C --> F[3ï¸âƒ£ GetSalepagePromotionDisplayTextProcessor]
    
    D --> G[å‘¼å« Cart ç«™å° API]
    G --> H[GetCart & CartCalculate]
    H --> I[å›å‚³ CartEntity]
    
    E --> J[å‘¼å«å‰å°ä¿ƒè³¼ API]
    J --> K["/api/promotion-rules/list-by-ids"]
    K --> L[Mapping æ´»å‹•è¦å‰‡]
    L --> M[å¡å…¥ PromotionRewardPointRules<br/>& PromotionRewardCouponRules]
    
    F --> N[è™•ç†å•†å“å¡æç¤ºæ–‡æ¡ˆ]
    N --> O[Title & Description]
    O --> P[å®¢è£½åŒ–æ’åºé¡¯ç¤º]
    
    I --> Q[åˆ¤æ–·æ´»å‹•æ˜¯å¦æœ‰ä¸­]
    M --> Q
    P --> Q
    
    Q --> R{isMatch?}
    R -->|true| S[æ´»å‹•å·²ä¸­ lackOfPrice: 0]
    R -->|false| T[æ´»å‹•æœªä¸­ é¡¯ç¤ºå·®åƒ¹]
    
    S --> U[æœ€çµ‚ CartEntity å›å‚³]
    T --> U
    
    style A fill:#e1f5fe
    style U fill:#c8e6c9
    style D fill:#fff3e0
    style E fill:#fff3e0
    style F fill:#fff3e0
    style Q fill:#f3e5f5
```

```text
flowchart TD
    A[å‰ç«¯è«‹æ±‚ CartCreate] --> B[çµ„å»º CartContext]
    B --> C{CartCreateProcessorLayers}
    
    C --> D[1ï¸âƒ£ CartCreateProcessor]
    C --> E[2ï¸âƒ£ ArrangePromotionRuleInfoProcessor]
    C --> F[3ï¸âƒ£ GetSalepagePromotionDisplayTextProcessor]
    
    D --> G[å‘¼å« Cart ç«™å° API]
    G --> H[GetCart & CartCalculate]
    H --> I[å›å‚³ CartEntity]
    
    E --> J[å‘¼å«å‰å°ä¿ƒè³¼ API]
    J --> K["/api/promotion-rules/list-by-ids"]
    K --> L[Mapping æ´»å‹•è¦å‰‡]
    L --> M[å¡å…¥ PromotionRewardPointRules<br/>& PromotionRewardCouponRules]
    
    F --> N[è™•ç†å•†å“å¡æç¤ºæ–‡æ¡ˆ]
    N --> O[Title & Description]
    O --> P[å®¢è£½åŒ–æ’åºé¡¯ç¤º]
    
    I --> Q[åˆ¤æ–·æ´»å‹•æ˜¯å¦æœ‰ä¸­]
    M --> Q
    P --> Q
    
    Q --> R{isMatch?}
    R -->|true| S[æ´»å‹•å·²ä¸­ lackOfPrice: 0]
    R -->|false| T[æ´»å‹•æœªä¸­ é¡¯ç¤ºå·®åƒ¹]
    
    S --> U[æœ€çµ‚ CartEntity å›å‚³]
    T --> U
    
    style A fill:#e1f5fe
    style U fill:#c8e6c9
    style D fill:#fff3e0
    style E fill:#fff3e0
    style F fill:#fff3e0
    style Q fill:#f3e5f5
```

### 1.3 ç›¸é—œå¿«å–

Cache:QA:Cart:Core:CartEntity-20230207:2:33132:06b830f4-f4c8-4fa3-974c-5d4793a06025

<br>

### 1.4 æ¸¬è©¦è³‡æ–™

**é»åŠ é‡‘**

<br>

- promotionIdï¼š6502, 6970
- salepageIdï¼š62146

<br>

### 1.5 åŠ åƒ¹è³¼

è¦å…ˆå»ºç«‹åŠ åƒ¹è³¼æ´»å‹•

<br>