# è³¼ç‰©è»Šæ–‡ä»¶

## ç›®éŒ„
1. [CartCreate](#1-cartcreate)
2. [çµ¦åˆ¸å›é¥‹æ´»å‹•ç‚ºç”šéº¼æ’é™¤äº†åŠ åƒ¹è³¼å­å•†å“ï¼Ÿ](#2-çµ¦åˆ¸å›é¥‹æ´»å‹•ç‚ºç”šéº¼æ’é™¤äº†åŠ åƒ¹è³¼å­å•†å“)
3. [é»åŠ é‡‘ç‚ºä»€éº¼ä¸é¡¯ç¤ºæ´»å‹•æ–‡æ¡ˆï¼Ÿ](#3-é»åŠ é‡‘ç‚ºä»€éº¼ä¸é¡¯ç¤ºæ´»å‹•æ–‡æ¡ˆ)
4. [APPï¼é–€å¸‚è³¼ç‰©è»Šä¸­æ‡‰é¿å…é¡¯ç¤ºå›é¥‹æ´»å‹•](#4-appé–€å¸‚è³¼ç‰©è»Šä¸­æ‡‰é¿å…é¡¯ç¤ºå›é¥‹æ´»å‹•)
5. [è³¼ç‰©è»Šç•°å¸¸_æ´»å‹•ç„¡ RuleRecord å°è‡´ S3 æ‹‰è³‡æ–™æœªæä¾› S3Key](#5-è³¼ç‰©è»Šç•°å¸¸_æ´»å‹•ç„¡-rulerecord-å°è‡´-s3-æ‹‰è³‡æ–™æœªæä¾›-s3key)
6. [é»åŠ é‡‘è³‡è¨Š](#6-é»åŠ é‡‘è³‡è¨Š)
7. [ListByIds API](#7-listbyids-api)
8. [è³¼ç‰©è»Šé¡¯ç¤º : IsDisplayInShoppingCart:True](#8-è³¼ç‰©è»Šé¡¯ç¤º--isdisplayinshoppingcarttrue)
9. [TagProductScope namespaceå•é¡Œ](#9-tagproductscope-namespaceå•é¡Œ)

<br>

---

## 1. CartCreate

urlï¼šhttps://shop2.shop.qa1.hk.91dev.tw/shopping/api/carts/create?lang=zh-HK&shopId=2

<br>

### 1.1 æ€éº¼åˆ¤æ–·æ´»å‹•æ˜¯å¦æœ‰ä¸­

promotionInfoList

<br>

- isMatchï¼štrue (åˆ¤æ–·è©²å•†å“æ˜¯å¦ä¸­æ´»å‹•)
- lackOfPriceï¼š0 (åˆ¤æ–·å·®å¤šå°‘éŒ¢)

<br>

### 1.2 æµç¨‹ç¸½è¦½

#### 1.2.1 ğŸ—‚ï¸ å‰ç«¯å‚³å…¥çš„æ¬„ä½

sourceï¼š"Web"ï¼Œä¸¦ç”¨ä¾†çµ„å»º CartContext

<br>

| å€å¡Š | æ¬„ä½èªªæ˜ |
|------|----------|
| æœƒå“¡èˆ‡è£ç½®è³‡è¨Š | - MemberId<br>- UnloginId<br>- IsP1Guest<br>- ShopId |
| ä½¿ç”¨è€…è¿½è¹¤ | - UserClientTrack<br>  - Source (ä¾‹å¦‚ "Web")<br>  - Channel<br>  - Device<br>  - Version<br>  - IsMobile |
| æ´»å‹•ä»£ç¢¼ | - PromoCodeDispatch.PromoCode |
| ç€è¦½å™¨è³‡è¨Š | - UserAgent<br>- HttpReferer |
| å•†åº—èˆ‡ä½ç½® | - LocationId |

<br>

#### 1.2.2 ğŸ§© CartCreateProcessorLayers æµç¨‹çµ„æˆ

| Processor | åŠŸèƒ½ |
|-----------|------|
| 1ï¸âƒ£ CartCreateProcessor | - ç”± CartService å‘¼å«ï¼Œæ‰“ Cart ç«™å°çš„ api/carts/create<br>- æœƒå‘¼å« GetCart èˆ‡ CartCalculate è™•ç†æµç¨‹<br>- å›å‚³ CartEntityï¼ŒåŒ…å«æ­£ç¢º PromotionEngineTypeDefEnum |
| 2ï¸âƒ£ ArrangePromotionRuleInfoProcessor | - æ•´ç†ä¿ƒè³¼æ´»å‹•è¦å‰‡è³‡è¨Š<br>- å‘¼å«å‰å°ä¿ƒè³¼ API /api/promotion-rules/list-by-ids<br>- å°‡å›å‚³çµæœ promotionsfromFrontendPromotionAPI èˆ‡ CartEntity.PromotionInfoList åšå°æ‡‰ Mapping<br>- æ´»å‹•è¦å‰‡å°æ‡‰ç¯€é»ï¼š<br>  - PromotionRewardPointRules<br>  - PromotionRewardCouponRules |
| 3ï¸âƒ£ GetSalepagePromotionDisplayTextProcessor | - è™•ç†è³¼ç‰©è»Š P1 å•†å“å¡ä¸Šçš„æ´»å‹•æç¤ºæ–‡æ¡ˆ (Title / Description)<br>- å¯å®¢è£½åŒ–æç¤ºæ–‡æ¡ˆé¡¯ç¤ºèˆ‡æ’åº |

<br>

#### 1.2.3 ğŸ“ é‡é»ç´°ç¯€èªªæ˜

ğŸ”¹ **1ï¸âƒ£ å‘¼å«å‰å°ä¿ƒè³¼ API**

<br>

```csharp
var promotionsfromFrontendPromotionAPI = await _promotionService.GetPromotionsAsync(promotionIds);
```

<br>

å‘¼å« /api/promotion-rules/list-by-ids

<br>

èˆ‡ CartEntity.PromotionInfoList åš Mapping

<br>

å¡å…¥ï¼š

<br>

- PromotionRewardPointRules
- PromotionRewardCouponRules

<br>

ğŸ”¹ **2ï¸âƒ£ æ´»å‹•æ’åºé‚è¼¯**

<br>

è‹¥éœ€è¦å®¢è£½åŒ–æ´»å‹•æ’åºï¼Œä½¿ç”¨ï¼šPromotionTypeComparer

<br>

ğŸ”¹ **3ï¸âƒ£ å•†å“å¡æç¤ºæ–‡æ¡ˆï¼ˆSalepage Promotion Displayï¼‰**

<br>

ä¸»è¦é€²å…¥é»ï¼š

<br>

```csharp
AssignPromotionDisplayText(context.Data);
```

<br>

ä¿®æ”¹ Titleï¼šéœ€å¯¦ä½œå°æ‡‰çš„ GetPromotionTitleText

<br>

ç¯„ä¾‹ï¼š

<br>

```csharp
public string GetPromotionTitleText(CartPromotionInfoEntity promotionInfo)
{
    return "ä½ çš„è‡ªè¨‚æ¨™é¡Œ";
}
```

<br>

ç¯„ä¾‹ï¼šRewardReachPriceWithCouponDisplayService

<br>

ä¿®æ”¹ Descriptionï¼š

<br>

ArrangePromotionDisplayTextAsync æœƒåˆ†åˆ¥è™•ç†ï¼š

<br>

- MatchedPromotion
- MismatchedPromotion

<br>

GetDisplayTypeDescription(promotion, displayTypeEnum).DisplayTypeDescription

<br>

æ˜¯å¦é¡¯ç¤ºï¼šè¦å°‡æ–‡æ¡ˆåŠ åˆ° SalepageDiscountDisplayEntity.DisplayText æ‰èƒ½é¡¯ç¤º

<br>

ç¢ºèªæœ‰å°‡æ´»å‹•é¡å‹åŠ å…¥ _salepageDisplayPromotionType

<br>

è‹¥è¦æ–°å¢æ´»å‹•é¡¯ç¤ºæœå‹™ï¼šéœ€æ–°å¢å°æ‡‰çš„ DisplayService

<br>

ç¯„ä¾‹ï¼šRewardReachPriceWithCouponDisplayService

<br>

**4ï¸âƒ£ æ˜¯å¦é¡¯ç¤ºæ´»å‹•è¦å‰‡**

<br>

æŸ¥ ShopStaticSetting è¨­å®šæ˜¯å¦é¡¯ç¤ºï¼š

<br>

```sql
select *
from ShopStaticSetting(nolock)
where ShopStaticSetting_ValidFlag = 1
  and ShopStaticSetting_GroupName = 'ShoppingCartSalepage'
  and ShopStaticSetting_Key = 'IsSalepagePromotionRule'
```

<br>

HKQA å•†åº—å¤§å¤šè¨­ç‚º FALSE

<br>

ç¯€é»ï¼šSalepageDiscountDisplayEntity.DisplayText

<br>

é–‹é—œï¼šisShowPromotionRuleTask => isShowPromotionRule

<br>

#### 1.2.4 ğŸ—’ï¸ è£œå……ï¼šæ´»å‹•åç¨±é¡¯ç¤º

é è¨­å¤šç‚º promotion.Name

<br>

#### 1.2.5 ğŸ·ï¸ é™„è¨»

è‹¥å¾ŒçºŒè¦æ“´å……æ–°çš„æ´»å‹•å‹æ…‹ï¼Œè¨˜å¾—ï¼š

<br>

- Promotion Engine TypeDef Enum è¦æ­£ç¢ºå°æ‡‰
- API /api/promotion-rules/list-by-ids è¦æœ‰å°æ‡‰è³‡æ–™
- æ–‡æ¡ˆèˆ‡æ’åºè¦åŒæ­¥èª¿æ•´

<br>

#### 1.2.6 ğŸ“‚ éœ€è¦ä¿®æ”¹çš„æª”æ¡ˆ

- PromotionEngineTypeDefEnum.cs
- GetSalepagePromotionDisplayTextProcessor.cs
- PromotionBaseDisplayService.cs
- GetPromotionEngineResponseEntity.cs
- ArrangePromotionRuleInfoProcessor.cs
- ServiceCollectionExtension.cs

<br>

#### 1.2.7 æµç¨‹åœ–

```mermaid
flowchart TD
    A[å‰ç«¯è«‹æ±‚ CartCreate] --> B[çµ„å»º CartContext]
    B --> C{CartCreateProcessorLayers}
    
    C --> D[1ï¸âƒ£ CartCreateProcessor]
    C --> E[2ï¸âƒ£ ArrangePromotionRuleInfoProcessor]
    C --> F[3ï¸âƒ£ GetSalepagePromotionDisplayTextProcessor]
    
    D --> G[å‘¼å« Cart ç«™å° API]
    G --> H[GetCart & CartCalculate]
    H --> I[å›å‚³ CartEntity]
    
    E --> J[å‘¼å«å‰å°ä¿ƒè³¼ API]
    J --> K["/api/promotion-rules/list-by-ids"]
    K --> L[Mapping æ´»å‹•è¦å‰‡]
    L --> M[å¡å…¥ PromotionRewardPointRules<br/>& PromotionRewardCouponRules]
    
    F --> N[è™•ç†å•†å“å¡æç¤ºæ–‡æ¡ˆ]
    N --> O[Title & Description]
    O --> P[å®¢è£½åŒ–æ’åºé¡¯ç¤º]
    
    I --> Q[åˆ¤æ–·æ´»å‹•æ˜¯å¦æœ‰ä¸­]
    M --> Q
    P --> Q
    
    Q --> R{isMatch?}
    R -->|true| S[æ´»å‹•å·²ä¸­ lackOfPrice: 0]
    R -->|false| T[æ´»å‹•æœªä¸­ é¡¯ç¤ºå·®åƒ¹]
    
    S --> U[æœ€çµ‚ CartEntity å›å‚³]
    T --> U
    
    style A fill:#e1f5fe
    style U fill:#c8e6c9
    style D fill:#fff3e0
    style E fill:#fff3e0
    style F fill:#fff3e0
    style Q fill:#f3e5f5
```

```text
flowchart TD
    A[å‰ç«¯è«‹æ±‚ CartCreate] --> B[çµ„å»º CartContext]
    B --> C{CartCreateProcessorLayers}
    
    C --> D[1ï¸âƒ£ CartCreateProcessor]
    C --> E[2ï¸âƒ£ ArrangePromotionRuleInfoProcessor]
    C --> F[3ï¸âƒ£ GetSalepagePromotionDisplayTextProcessor]
    
    D --> G[å‘¼å« Cart ç«™å° API]
    G --> H[GetCart & CartCalculate]
    H --> I[å›å‚³ CartEntity]
    
    E --> J[å‘¼å«å‰å°ä¿ƒè³¼ API]
    J --> K["/api/promotion-rules/list-by-ids"]
    K --> L[Mapping æ´»å‹•è¦å‰‡]
    L --> M[å¡å…¥ PromotionRewardPointRules<br/>& PromotionRewardCouponRules]
    
    F --> N[è™•ç†å•†å“å¡æç¤ºæ–‡æ¡ˆ]
    N --> O[Title & Description]
    O --> P[å®¢è£½åŒ–æ’åºé¡¯ç¤º]
    
    I --> Q[åˆ¤æ–·æ´»å‹•æ˜¯å¦æœ‰ä¸­]
    M --> Q
    P --> Q
    
    Q --> R{isMatch?}
    R -->|true| S[æ´»å‹•å·²ä¸­ lackOfPrice: 0]
    R -->|false| T[æ´»å‹•æœªä¸­ é¡¯ç¤ºå·®åƒ¹]
    
    S --> U[æœ€çµ‚ CartEntity å›å‚³]
    T --> U
    
    style A fill:#e1f5fe
    style U fill:#c8e6c9
    style D fill:#fff3e0
    style E fill:#fff3e0
    style F fill:#fff3e0
    style Q fill:#f3e5f5
```

#### 1.2.8 GetCartProcessorLayers è©³ç´°èªªæ˜

**CartCreateProcessor (å–å¾—è³¼ç‰©è»Šæµç¨‹)**

<br>

å–®ç´”ç”¨ç°¡å–®çš„è³‡è¨Šå»ºç«‹è»Šçš„åŸºæœ¬è³‡è¨Šï¼Œèˆ‡ Promotion è¼ƒç„¡é—œä¿‚

<br>

**ExecuteLogisticCalculateProcessor<CartEntity> (åŸ·è¡Œè¨ˆç®—è³¼ç‰©è»Šçš„æµç¨‹)**

<br>

```csharp
cartContext.Data.IsCartCalculate = true;
```

<br>

LogisticCalculateProcessorLayers > CalculatePromotionProcessor (è¨ˆç®—ä¿ƒè³¼æµç¨‹) ListById > æ‰“ä¿ƒè³¼å‰å°è³¼ç‰©è»Šè¨ˆç®— API

<br>

```csharp
//// æ–¹æ³•å…¥å£
var requestData = await this._promotionService.ArrangePromotionPayloadAsync(context);

//// æ‰“ä¿ƒè³¼å‰å°è³¼ç‰©è»Šè¨ˆç®— API
var promotionResult = await this._promotionService.CalculateAsync(requestData);
```

<br>

æ‰“ /api/cart-calculate

<br>

```csharp
//// å¦‚æœ log æ‹¿åˆ°ä»¥ä¸‹è¨Šæ¯è¡¨ç¤º SalepageSkulist, PromotionRecordList, PromotionInstructionList æ˜¯ç©ºçš„ (æ²’æœ‰ä¿ƒè³¼ç›¸é—œè³‡è¨Š)
æŠ˜æ‰£æ´»å‹•è¨ˆç®—å›å‚³ç©ºçš„SkuList, requestId: {promotionResult!.RequestId}
```

<br>

å°‡æ´»å‹•è¨ˆç®—çµæœæ›´æ–°å› CartEntity (PromotionInfoList)

<br>

```csharp
//// æ–¹æ³•å…¥å£
await MappingPromotionToCartAsync(context, promotionResult);

//// æ–¹æ³•å…§æœƒæ’é™¤ç›®å‰ä¸æ”¯æ´çš„æ´»å‹•ï¼Œé€™è£¡æœƒç¯©é¸æ‰ç„¡æ³•mappingçš„enum
allRuleIds = promotionResult.RuleList
                .Where(x =>
                    x.SourceType == SourceTypeEnum.Promotion &&
                    allRuleIds.Contains(x.RuleId) &&
                    PromotionHelper.ExtractPromotionEngineTypeDef(x.TypeDef).HasValue)
                .Select(x => x.RuleId).ToList();
```

<br>

```csharp
//// å–å¾—æ´»å‹•è³‡è¨Š,æ‰“ä¿ƒè³¼å‰å° list-by-ids API
GetPromotionsAsync 
/api/promotion-rules/list-by-ids
```

<br>

```csharp
//// æœªé”é–€æª»å¤šå°‘çš„è³‡è¨Šå¯«åœ¨é€™
promotionInstruction.State ç¯€é»

//////// æœªä¸­çš„æ´»å‹•è™•ç†
if (promotionInfo.IsMatch == false)

//// å°‡æ´»å‹•è¨ˆç®—æ›´æ–°å›è³¼ç‰©è»Šå•†å“é 
MappingPromotionSkuToCart(context, promotionResult);
```

<br>

### 1.3 ç›¸é—œå¿«å–

Cache:QA:Cart:Core:CartEntity-20230207:2:33132:06b830f4-f4c8-4fa3-974c-5d4793a06025

<br>

### 1.4 æ¸¬è©¦è³‡æ–™

**é»åŠ é‡‘**

<br>

- promotionIdï¼š6502, 6970
- salepageIdï¼š62146

<br>

### 1.5 åŠ åƒ¹è³¼

è¦å…ˆå»ºç«‹åŠ åƒ¹è³¼æ´»å‹•

<br>

### 1.6 è³¼ç‰©è»Šæ´»å‹•è³‡æ–™æ•´ç†æµç¨‹åœ–

```mermaid
flowchart LR
  %% ç¯€é»æ¨£å¼
  classDef userStyle fill:#E3F2FD,stroke:#2196F3,stroke-width:2px;
  classDef shoppingStyle fill:#FFF3E0,stroke:#FF9800,stroke-width:2px;
  classDef cartStyle fill:#E8F5E9,stroke:#4CAF50,stroke-width:2px;
  classDef promoStyle fill:#FCE4EC,stroke:#E91E63,stroke-width:2px;
  classDef dataStyle fill:#F3E5F5,stroke:#AB47BC,stroke-width:2px;

  %% ä½¿ç”¨è€…å±¤
  subgraph ä½¿ç”¨è€…
    U1([ğŸ›’ å»ºç«‹è³¼ç‰©è»Š])
  end

  %% Shopping å±¤
  subgraph Shopping ç«™å°
    S1([ğŸ”— API /shopping/api/carts/create])
    S2([ğŸ“¦ CartCreateProcessor])
    S3([ğŸ“Š ArrangePromotionRuleInfoProcessor])
    S4([ğŸ“ GetSalepagePromotionDisplayTextProcessor])
    S5([ğŸ¨ RewardReachPriceWithCouponDisplayService])
  end

  %% Cart å±¤
  subgraph Cart ç«™å°
    C1([ğŸ” GetCartProcessorLayers])
    C2([âš™ï¸ ExecuteLogisticCalculateProcessor])
    C3([ğŸ“ CalculatePromotionProcessor])
    C4([ğŸ§¾ MappingPromotionToCart])
  end

  %% Promotion å±¤
  subgraph Promotion Web å‰å°
    P1([ğŸ§® /api/cart-calculate])
    P2([ğŸ¯ /api/promotion-rules/list-by-ids])
    P3([ğŸ§© RewardReachPriceWithCouponRuleService])
  end

  %% è³‡æ–™ç¯€é»
  D1([ğŸ“„ CartEntity])
  D2([ğŸ“„ PromotionInfoList])
  D3([ğŸ’¬ æ´»å‹•æ–‡æ¡ˆï¼šGetPromotionHintText])
  D4([ğŸ“œ ç¼ºå°‘é‡‘é¡ï¼šLackOfPrice])
  D5([ğŸŸï¸ çµ¦åˆ¸è¦å‰‡ï¼šPromotionRewardCouponRuleEntity])

  %% æµç¨‹é€£ç·š
  U1 --> S1
  S1 --> S2
  S2 --> C1
  C1 --> C2
  C2 --> C3
  C3 --> P1 --> P3
  C3 --> C4 --> D1

  S2 --> S3
  S3 --> P2 --> P3
  P2 --> D2 --> S4
  S4 --> S5
  S5 --> D3
  D2 --> D4
  D2 --> D5

  %% æ¨£å¼æ‡‰ç”¨
  class U1 userStyle
  class S1,S2,S3,S4,S5 shoppingStyle
  class C1,C2,C3,C4,D1,D2 cartStyle
  class P1,P2,P3 promoStyle
  class D3,D4,D5 dataStyle
```

<br>

---

## 2. çµ¦åˆ¸å›é¥‹æ´»å‹•ç‚ºç”šéº¼æ’é™¤äº†åŠ åƒ¹è³¼å­å•†å“ï¼Ÿ

### 2.1 Bug æ¡ˆä¾‹çš„ Request

ç¢ºèª Bug æ¡ˆä¾‹çš„ Request

<br>

ä¸»å•†å“ 62227 å¸¶ Flag AddOnsSalepageMajor

<br>

å­å•†å“ 60393 å¸¶ Flag AddOnsSalepageSub

<br>

```json
{
   "Shop":{
      "Id":11,
      "Tags":[
         "EnableAddOns"
      ]
   },
   "User":{
      "Id":"33502",
      "Tags":[
         "AllUserScope",
         "CrmShopMemberCard:24",
         "FirstPurchase"
      ],
      "OuterId":null,
      "ShopMemberCode":"97+Gy73RMbUYz5ZqI4EuEA=="
   },
   "Shipping":{
      "ShippingProfileTypeDef":"Home",
      "ShippingAreaId":0,
      "CountryProfileId":85,
      "LocationId":0
   },
   "Payment":{
      "PayProfileTypeDef":"TwoCTwoP"
   },
   "Channel":"AppIOS",
   "CurrencyDecimalDigits":2,
   "SalepageSkuList":[
      {
         "SalepageId":62227,
         "SkuId":86642,
         "Price":4.5,
         "SuggestPrice":10000.0,
         "Qty":14,
         "Flags":[
            "AddOnsSalepageMajor"
         ],
         "OuterId":"123",
         "Tags":null,
         "OptionalTypeDef":"",
         "OptionalTypeId":0,
         "CartExtendInfoItemGroup":1748912653812,
         "CartExtendInfoItemType":"Major",
         "PointsPayPair":null,
         "CartExtendInfos":[
            {
               "RuleTypeDef":"AddOnsSalepageExtraPurchase",
               "RuleId":10000050,
               "RelatedItemCartIds":[
                  45514
               ],
               "RelatedSubItemCount":0
            }
         ],
         "CartId":45513
      },
      {
         "SalepageId":60393,
         "SkuId":84109,
         "Price":6.66,
         "SuggestPrice":100.0,
         "Qty":1,
         "Flags":[
            "AddOnsSalepageSub"
         ],
         "OuterId":"",
         "Tags":null,
         "OptionalTypeDef":"",
         "OptionalTypeId":0,
         "CartExtendInfoItemGroup":1748912653812,
         "CartExtendInfoItemType":"Sub",
         "PointsPayPair":null,
         "CartExtendInfos":[
            {
               "RuleTypeDef":"AddOnsSalepageExtraPurchase",
               "RuleId":10000050,
               "RelatedItemCartIds":[
                  
               ],
               "RelatedSubItemCount":0
            }
         ],
         "CartId":45514
      }
   ],
   "FeeList":[
      {
         "Id":221,
         "Type":"ShippingFee",
         "Price":0,
         "Payment":0,
         "ExtendInfo":{
            "ShippingProfileTypeDef":"Home",
            "IsDomesticWeightPricing":false,
            "TemperatureTypeDef":"Normal",
            "ShippingType":"221",
            "ShippingAreaId":84,
            "IsLocal":true
         }
      }
   ],
   "Promotion":{
      "Code":null,
      "PromoCodePoolGroupId":null,
      "SelectedDesignatePaymentPromotionId":0
   },
   "CouponSetting":{
      "MultipleRedeem":{
         "Discount":{
            "IsMultiple":false,
            "Qty":1
         },
         "Gift":{
            "IsMultiple":true,
            "Qty":9999
         },
         "Shipping":{
            "IsMultiple":false,
            "Qty":1
         }
      },
      "CouponList":[
         
      ],
      "Options":{
         "IsVerbose":false,
         "IsCouponPreSelect":true,
         "IncludeRecordDetail":false
      },
      "LoyaltyPoint":{
         "CheckoutPoint":0,
         "CheckoutDiscountPrice":0,
         "IsSelected":false,
         "IsSetDiscountPrice":false,
         "TotalPoint":0.0
      }
   }
}
```

<br>

### 2.2 å•é¡Œåˆ†æ

ç¢ºèªä¿ƒè³¼å‰å°æµç¨‹è¨ˆç®—å‰åš LoadRulesï¼Œç´°é …æœƒåš RuleInit

<br>

è¿½åˆ°å¼•æ“ç¨‹å¼ç¢¼å¾Œï¼Œç™¼ç¾å›é¥‹æ´»å‹•çµ¦åˆ¸æœƒæœ‰åŠ ä¸Šæ’é™¤çš„ Tag

<br>

```csharp
public override void RuleInitProcess()
{
    this.ExclusiveTags ??= new HashSet<string>();
    this.ExclusiveTags.Add(FlagConstants.AddOnsSalepageSub);
    this.ExclusiveTags.Add(FlagConstants.CouponExcludedByOrder);
}
```

<br>

ç¢ºèªæ–°èˆŠçµ¦é»éƒ½æ²’æœ‰é€™å€‹ ExclusiveTagsï¼Œå› æ­¤å›é¥‹çµ¦åˆ¸ç§»é™¤ FlagConstants.AddOnsSalepageSub

<br>

---

## 3. é»åŠ é‡‘ç‚ºä»€éº¼ä¸é¡¯ç¤ºæ´»å‹•æ–‡æ¡ˆï¼Ÿ

**ç«™å°**ï¼šShopping

<br>

**è™•ç†å™¨**ï¼šGetSalepagePromotionDisplayTextProcessor

<br>

æ—¢æœ‰åˆ¤æ–·å¼åƒ…é™ DiscountReachPriceWithFreeGift å¯ä»¥é¡¯ç¤ºé»åŠ é‡‘å•†å“ï¼Œå¦å‰‡è©²æ´»å‹•è³¦å€¼ç‚º null

<br>

```csharp
//// é»åŠ é‡‘å•†å“å¯ä»¥é¡¯ç¤ºæ´»å‹•è³‡è¨Šï¼Œä½†ç›®å‰åªé–‹æ”¾æ»¿é¡è´ˆ
if (salepage.IsPointsPayPair && promotion?.Type != PromotionEngineTypeDefEnum.DiscountReachPriceWithFreeGift)
{
    promotion = null;
}
```

<br>

å› æ­¤ä¿®æ­£åŠ å…¥ 3 å€‹å›é¥‹æ´»å‹•

<br>

---

## 4. APPï¼é–€å¸‚è³¼ç‰©è»Šä¸­æ‡‰é¿å…é¡¯ç¤ºå›é¥‹æ´»å‹•

åŒ…å«ï¼š

<br>

æ–°èˆŠé»æ•¸å›é¥‹æ´»å‹•

<br>

å›é¥‹åˆ¸æ´»å‹•

<br>

æ•´ç†èªªæ˜

<br>

ç›®å‰è³¼ç‰©è»ŠåŠŸèƒ½æœƒåŒæ™‚åœ¨ APP / å®˜ç¶²ä¸Šå…±ç”¨ï¼Œä½†å¯¦ä½œä¸Šæœƒå°‡å¸¶æœ‰ LackSalesChannel çš„ã€Œæœ‰ç·šä¸‹é€šè·¯ã€æ´»å‹•æœ‰å¸¶ä¸Š â¡ï¸ å¯¦éš›ä¸Šæ­¤é‚è¼¯ä¸åˆç†

<br>

æŠ€è¡“èª¿æ•´èªªæ˜

<br>

**æ‰€å±¬æ¨¡çµ„**

<br>

**ç«™å°**ï¼šShopping

<br>

**è™•ç†å™¨**ï¼šGetSalepagePromotionDisplayTextProcessor

<br>

**åŸå•é¡Œé»**

<br>

åœ¨ FilteredPromotion ç¯©é¸ä¸­ï¼Œç•¶æ´»å‹•é¡å‹ç‚º å›é¥‹æ´»å‹• ä¸”æ¢ä»¶ mismatch æ™‚

<br>

ç³»çµ±æœªæ’é™¤ LackSalesChannel å¸¶æœ‰ç·šä¸‹é€šè·¯çš„æ´»å‹•

<br>

**å¯¦éš›å½±éŸ¿**

<br>

åƒ… APP / LocationWizard / InStore é¡å‹çš„æ´»å‹•ï¼Œåœ¨è³¼ç‰©è»Šä¸­æœƒé¡¯ç¤º

<br>

èª¿æ•´æ–¹å‘

<br>

èª¿æ•´åˆ¤æ–·é‚è¼¯ï¼Œä½¿ã€Œå›é¥‹æ´»å‹•ã€åœ¨è³¼ç‰©è»Šä¸­é¡¯ç¤ºæ™‚æ’é™¤ LackSalesChannel æœ‰ LocationWizard / InStore çš„æ¢ä»¶

<br>

APP / é–€å¸‚è³¼ç‰©è»Šèƒ½æ­£ä¸é¡¯ç¤ºå°æ‡‰ä¿ƒéŠ·æ´»å‹•

<br>

**PR**ï¼šhttps://gitlab.91app.com/commerce-cloud/nine1.shopping/-/merge_requests/1739/diffs

<br>

---

## 5. è³¼ç‰©è»Šç•°å¸¸_æ´»å‹•ç„¡ RuleRecord å°è‡´ S3 æ‹‰è³‡æ–™æœªæä¾› S3Key

https://91app.slack.com/archives/C63SH8G3D/p1740995912013989

<br>

**Cart**ï¼š/api/carts/creat

<br>

**Promotion**ï¼š/api/cart-calculate

<br>

![alt text](./image-4.png)

<br>

è©²ç­†æ´»å‹• (Id : 5723 )å› å¾Œå°é‚„åœ¨é–‹ç™¼ä¸­å°è‡´é«’è³‡æ–™å‡ºç¾, è©²æ´»å‹•ç„¡ RuleRecord, ä¿ƒè³¼å‰å°åš CartCreate PromotionCalculateæ™‚, æ¬²å¾ S3 å–å¾—è³‡æ–™ , ä½†å› ç„¡æä¾› RuleRecord S3Key å°è‡´ Amazon NullReference

<br>

![alt text](./image-5.png)

<br>

=> éœ€è¦æª¢æŸ¥ RuleRecord

<br>

---

## 6. é»åŠ é‡‘è³‡è¨Š

**APIï¼š** /cart-calculate

<br>

**Calculate Data**

<br>

```json
"Flags": ["PointsPay", "AddOnsSalepageMajor"]
```

<br>

```json
"PointsPayPair": {
  "PointsPayId": 682,
  "ShopId": null,
  "SalePageId": null,
  "PairsPrice": 50.00,
  "PairsPoints": 50.00,
  "OriginPairsPrice": 50.00,
  "OriginPairsPoints": 50.00
}
```

<br>

---

## 7. ListByIds API

**APIï¼š** /api/promotion-rules/list-by-ids

<br>

### 7.1 æ‡‰ç”¨å ´æ™¯

**æ¡ˆä¾‹ 1ï¼šShopping**

<br>

ArrangePromotionRuleInfoProcessor

<br>

**æ¡ˆä¾‹ 2ï¼šCart**

<br>

Cart åœ¨ `await MappingPromotionToCartAsync(context, promotionResult);` æ™‚æœƒæ‰“ä¸€æ¬¡è©² API å–å¾—æ´»å‹•ç›¸é—œè³‡è¨Š

<br>

```csharp
var promotions = await this._promotionService.GetPromotionListAsync(allRuleIds);
```

<br>

---

## 8. è³¼ç‰©è»Šé¡¯ç¤º : IsDisplayInShoppingCart:True

é€™è£¡æœƒè³‡æ–™åº«æœƒæ‹‰ PromotionEngineSetting Table çš„ CustomField1ï¼Œå…§å®¹æ˜¯ IsDisplayInShoppingCart:Trueï¼Œæœƒå½±éŸ¿æ˜¯å¦é¡¯ç¤ºåœ¨è³¼ç‰©è»Š

<br>

```csharp
CustomField1 = setting.PromotionEngineSetting_CustomField1,
```

<br>

é€™è£¡æ–°å¢çš„æ´»å‹•éœ€è¦å¯¦ä½œè‡ªå·±çš„ Rule Serviceï¼Œä¾‹å¦‚ RewardReachPriceWithCouponRuleServiceï¼Œç”¨åœ¨å¡ cartPromotion.IsDisplayInShoppingCart çš„å¸ƒæ—ç¯€é»

<br>

```csharp
ruleService.SetCustomField1ForCart(promotion.CustomField1, promotion);
```

<br>

**ç¯„ä¾‹ï¼š**

<br>

```csharp
public override void SetCustomField1ForCart(string customFiled, PromotionEngineForCartResponseEntity cartPromotion)
{
    var isDisplay = true;

    try
    {
        bool.TryParse(customFiled?.Split(":")[1], out isDisplay);
    }
    catch (Exception)
    {
        isDisplay = true;
    }

    cartPromotion.IsDisplayInShoppingCart = isDisplay;
}
```

<br>

è¨˜å¾—è¦è®“é€™å€‹æ–°å¢çš„ Service èƒ½å¤  Reference + è¨»å†Š

<br>

**ç¯„ä¾‹ï¼š**

<br>

```csharp
// PromotionEngines\PromotionEngineService.GetRuleService
nameof(PromotionEngineTypeDefEnum.RewardReachPriceWithCoupon) => this._serviceProvider.GetRequiredService<RewardReachPriceWithCouponRuleService>(),

// è¨»å†Š
builder.Services.AddScoped<RewardReachPriceWithCouponRuleService>();
```

<br>

---

## 9. TagProductScope namespaceå•é¡Œ

â˜˜ï¸ **æ­£ç¢ºï¼š** `using NineYi.Msa.Tagging;`

<br>

â›” **éŒ¯èª¤ï¼š** `NineYi.Msa.Promotion.PriceEngine.Tagging;`

<br>

æœƒé€ æˆ ParseRule å¤±æ•—ï¼ï¼

<br>