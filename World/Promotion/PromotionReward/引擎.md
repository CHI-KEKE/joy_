# 引擎文件

## 目錄
1. [UserTags](#1-usertags)
2. [PromotionRules](#2-promotionrules)
3. [MatchedProcess](#3-matchedprocess)
4. [MismatchedProcess](#4-mismatchedprocess)

<br>

---

## 1. UserTags

### 1.1 Cart API 的 GetUserTags 方法

Cart API 的 GetUserTags 方法會取得會員於購物車流程中的「會員標籤」，標籤將用於促銷引擎判斷目標對象（如：全會員、新會員、指定卡別會員）。

<br>

```csharp
/// <summary>
/// 取得會員標籤
/// </summary>
/// <param name="context">CartContext</param>
/// <param name="vipMember">VipMemberBriefDataEntity</param>
/// <returns>會員標籤</returns>
private string[] GetUserTags(CartContext context, VipMemberBriefDataEntity? vipMember)
{
    var userTags = new List<string>
    {
        PromotionEngineConstants.AllUserScope
    };

    if (context.Data.HasCrmShopContract == true)
    {
        userTags.Add($"{PromotionEngineConstants.CrmShopMemberCard}:{context.Data.CrmMemberTier.CrmShopMemberCardId}");
    }

    if (vipMember == null)
    {
        return userTags.ToArray();
    }

    if (vipMember.IsFirstPurchase)
    {
        userTags.Add(PromotionEngineConstants.FirstPurchase);
    }

    return userTags.ToArray();
}
```

<br>

📝 輸出範例

<br>

```json
["AllUserScope"]
```

<br>

```json
["AllUserScope", "CrmShopMemberCard:5"]
```

<br>

```json
["AllUserScope", "FirstPurchase"]
```

<br>

### 1.2 促購前台組成 Threshold

促購前台會根據 RewardPointRuleList 組成活動條件門檻（Threshold），以便促銷引擎在判斷是否給點時，依據不同會員卡分組進行。

<br>

```csharp
/// <summary>
/// 組成促購引擎規則
/// </summary>
/// <param name="promotionEngineId">PromotionEngine_Id</param>
/// <param name="entity">PromotionBaseEntity</param>
/// <returns>PromotionEngine_Rule Json String</returns>
public string GetPromotionEngineRule(long promotionEngineId, PromotionBaseEntity entity)
{
    //// 組成活動條件階層
    var thresholds = new Dictionary<string, RewardReachPriceWithPointThreshold>();

    //// 給點條件
    entity.RewardPointRuleList.ForEach(rewardPointRule =>
    {
        if (decimal.TryParse(rewardPointRule.Condition.ToString(), out var reachPrice) == false || rewardPointRule.Point == null)
        {
            throw new ApplicationException("活動折抵條件有誤");
        }

        var rewardReachPriceWithPointThreshold = new RewardReachPriceWithPointThreshold()
        {
            ReachPricePointPairs = new List<ReachPricePointPair>()
            {
                new ReachPricePointPair(reachPrice, rewardPointRule.Point.Value)
            }
        };

        //// 若 CrmShopMemberCardId = 0，代表活動適用全體會員
        var crmShopMemberCard = rewardPointRule.CrmShopMemberCardId == 0 ?
            nameof(AllUserScope) :
            $"CrmShopMemberCard:{rewardPointRule.CrmShopMemberCardId}";

        thresholds.Add(crmShopMemberCard, rewardReachPriceWithPointThreshold);
    });
}
```

<br>

📝 輸出範例

<br>

```json
{
  "AllUserScope": {
    "ReachPricePointPairs": [
      { "ReachPrice": 1000, "Point": 50 }
    ]
  },
  "CrmShopMemberCard:5": {
    "ReachPricePointPairs": [
      { "ReachPrice": 800, "Point": 80 }
    ]
  }
}
```

<br>

會員標籤（UserTags）與 Threshold Key 對應：前台組成 UserTags，後台 Thresholds 以相同 Tag 為 Key，促銷引擎在執行時做交集比對。

<br>

CrmShopMemberCardId = 0：代表適用所有會員，使用 AllUserScope。

<br>

---

## 2. PromotionRules

### 2.1 取用 this.Rules

- IsMatchedDate => 看活動的 Since / Until
- Enabled

<br>

### 2.2 Priority

Priority 看起來是有內定排序

<br>

### 2.3 IsSkipped

IsSkipped 在引擎有的 rule 會定義 skip RuleId

<br>

---

## 3. MatchedProcess

活動去 loop 這個購物車的商品

<br>

### 3.1 取得 threshold

<br>

### 3.2 GetMatchedProductScopeItems

IsInScope：確認 PurchaseItems 是否在 productItem.Tags 裡面 (TagProductScope)

<br>

OrderBy SalePrice

<br>

thenOrderBy PromotionEngineId

<br>

### 3.3 TotalPrice

TotalPrice = SalePrice 的 Sum

<br>

### 3.4 計算方式

**獨立計算**：Product.GroupKey 會是 TS，每一張 TS.SalessPrice * priceRateAndPointPair.Rate，最後 SUM 出這整張 TG 的 points

<br>

**合併計算**：TotalPrice 直接 * priceRateAndPointPair.Rate

<br>

### 3.5 產生 PromotionRecord

- PromotionId
- SourceType = Promotion
- Group = CartCalculate
- Point = 會有最大給點數的限制
- PurchasedItemIds
- NeedAmortization = no need to 攤提

<br>

---

## 4. MismatchedProcess

### 4.1 AddPromotionInstruction

#### 4.1.1 GetThreshold

<br>

#### 4.1.2 活動處理流程

有中活動找下一階，填上 DisplayHintInstruction 的：

<br>

- PromotionRuleId
- SourceType
- State = HintInfo

<br>

```json
{
  "LackSalesChannel": "位元處理",
  "LackOfPrice": "Math.Max(targetPair.ReachPrice - purchasedItemPrice, 0)",
  "Fulfilment": "targetPair"
}
```

<br>

#### 4.1.3 PurchaseItem 標記

每一個 purchaseItem 都有 Flags，要在沒中該活動的 purchaseItem 掛上對應 Promotion 的 TagsWhenMismatched

<br>