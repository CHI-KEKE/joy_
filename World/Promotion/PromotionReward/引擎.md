# å¼•æ“æ–‡ä»¶

## ç›®éŒ„
1. [UserTags](#1-usertags)

<br>

---

## 1. UserTags

### 1.1 Cart API çš„ GetUserTags æ–¹æ³•

Cart API çš„ GetUserTags æ–¹æ³•æœƒå–å¾—æœƒå“¡æ–¼è³¼ç‰©è»Šæµç¨‹ä¸­çš„ã€Œæœƒå“¡æ¨™ç±¤ã€ï¼Œæ¨™ç±¤å°‡ç”¨æ–¼ä¿ƒéŠ·å¼•æ“åˆ¤æ–·ç›®æ¨™å°è±¡ï¼ˆå¦‚ï¼šå…¨æœƒå“¡ã€æ–°æœƒå“¡ã€æŒ‡å®šå¡åˆ¥æœƒå“¡ï¼‰ã€‚

<br>

```csharp
/// <summary>
/// å–å¾—æœƒå“¡æ¨™ç±¤
/// </summary>
/// <param name="context">CartContext</param>
/// <param name="vipMember">VipMemberBriefDataEntity</param>
/// <returns>æœƒå“¡æ¨™ç±¤</returns>
private string[] GetUserTags(CartContext context, VipMemberBriefDataEntity? vipMember)
{
    var userTags = new List<string>
    {
        PromotionEngineConstants.AllUserScope
    };

    if (context.Data.HasCrmShopContract == true)
    {
        userTags.Add($"{PromotionEngineConstants.CrmShopMemberCard}:{context.Data.CrmMemberTier.CrmShopMemberCardId}");
    }

    if (vipMember == null)
    {
        return userTags.ToArray();
    }

    if (vipMember.IsFirstPurchase)
    {
        userTags.Add(PromotionEngineConstants.FirstPurchase);
    }

    return userTags.ToArray();
}
```

<br>

ğŸ“ è¼¸å‡ºç¯„ä¾‹

<br>

```json
["AllUserScope"]
```

<br>

```json
["AllUserScope", "CrmShopMemberCard:5"]
```

<br>

```json
["AllUserScope", "FirstPurchase"]
```

<br>

### 1.2 ä¿ƒè³¼å‰å°çµ„æˆ Threshold

ä¿ƒè³¼å‰å°æœƒæ ¹æ“š RewardPointRuleList çµ„æˆæ´»å‹•æ¢ä»¶é–€æª»ï¼ˆThresholdï¼‰ï¼Œä»¥ä¾¿ä¿ƒéŠ·å¼•æ“åœ¨åˆ¤æ–·æ˜¯å¦çµ¦é»æ™‚ï¼Œä¾æ“šä¸åŒæœƒå“¡å¡åˆ†çµ„é€²è¡Œã€‚

<br>

```csharp
/// <summary>
/// çµ„æˆä¿ƒè³¼å¼•æ“è¦å‰‡
/// </summary>
/// <param name="promotionEngineId">PromotionEngine_Id</param>
/// <param name="entity">PromotionBaseEntity</param>
/// <returns>PromotionEngine_Rule Json String</returns>
public string GetPromotionEngineRule(long promotionEngineId, PromotionBaseEntity entity)
{
    //// çµ„æˆæ´»å‹•æ¢ä»¶éšå±¤
    var thresholds = new Dictionary<string, RewardReachPriceWithPointThreshold>();

    //// çµ¦é»æ¢ä»¶
    entity.RewardPointRuleList.ForEach(rewardPointRule =>
    {
        if (decimal.TryParse(rewardPointRule.Condition.ToString(), out var reachPrice) == false || rewardPointRule.Point == null)
        {
            throw new ApplicationException("æ´»å‹•æŠ˜æŠµæ¢ä»¶æœ‰èª¤");
        }

        var rewardReachPriceWithPointThreshold = new RewardReachPriceWithPointThreshold()
        {
            ReachPricePointPairs = new List<ReachPricePointPair>()
            {
                new ReachPricePointPair(reachPrice, rewardPointRule.Point.Value)
            }
        };

        //// è‹¥ CrmShopMemberCardId = 0ï¼Œä»£è¡¨æ´»å‹•é©ç”¨å…¨é«”æœƒå“¡
        var crmShopMemberCard = rewardPointRule.CrmShopMemberCardId == 0 ?
            nameof(AllUserScope) :
            $"CrmShopMemberCard:{rewardPointRule.CrmShopMemberCardId}";

        thresholds.Add(crmShopMemberCard, rewardReachPriceWithPointThreshold);
    });
}
```

<br>

ğŸ“ è¼¸å‡ºç¯„ä¾‹

<br>

```json
{
  "AllUserScope": {
    "ReachPricePointPairs": [
      { "ReachPrice": 1000, "Point": 50 }
    ]
  },
  "CrmShopMemberCard:5": {
    "ReachPricePointPairs": [
      { "ReachPrice": 800, "Point": 80 }
    ]
  }
}
```

<br>

æœƒå“¡æ¨™ç±¤ï¼ˆUserTagsï¼‰èˆ‡ Threshold Key å°æ‡‰ï¼šå‰å°çµ„æˆ UserTagsï¼Œå¾Œå° Thresholds ä»¥ç›¸åŒ Tag ç‚º Keyï¼Œä¿ƒéŠ·å¼•æ“åœ¨åŸ·è¡Œæ™‚åšäº¤é›†æ¯”å°ã€‚

<br>

CrmShopMemberCardId = 0ï¼šä»£è¡¨é©ç”¨æ‰€æœ‰æœƒå“¡ï¼Œä½¿ç”¨ AllUserScopeã€‚

<br>