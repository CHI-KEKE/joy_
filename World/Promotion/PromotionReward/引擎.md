# å¼•æ“æ–‡ä»¶

## ç›®éŒ„
1. [UserTags](#1-usertags)
2. [PromotionRules](#2-promotionrules)
3. [MatchedProcess](#3-matchedprocess)
4. [MismatchedProcess](#4-mismatchedprocess)
5. [æ’é™¤å•†å“](#5-æ’é™¤å•†å“)
6. [çµ„åˆå•†å“](#6-çµ„åˆå•†å“)
7. [æ”¤æèˆ‡QTY](#7-æ”¤æèˆ‡qty)
8. [åœˆå•†å“çµæ§‹](#8-åœˆå•†å“çµæ§‹)
9. [åœˆæœƒå“¡](#9-åœˆæœƒå“¡)
10. [åœˆLocation](#10-åœˆlocation)
11. [ä¿ƒè³¼å‰å°ç™¼é€](#11-ä¿ƒè³¼å‰å°ç™¼é€)
12. [Thresholdsçµæ§‹](#12-thresholdsçµæ§‹)
13. [åˆä½µèˆ‡ç¨ç«‹è¨ˆç®—](#13-åˆä½µèˆ‡ç¨ç«‹è¨ˆç®—)
14. [é—œæ–¼åƒ… TS æ”¤æé€€æ¬¾ç‚ºç”šéº¼æ¶ˆè²»è€…ä»æœƒæ‹¿åˆ°æ¯”è¼ƒå¤šå¾—ç¾è±¡](#14-é—œæ–¼åƒ…-ts-æ”¤æé€€æ¬¾ç‚ºç”šéº¼æ¶ˆè²»è€…ä»æœƒæ‹¿åˆ°æ¯”è¼ƒå¤šå¾—ç¾è±¡)

<br>

---

## 1. UserTags

### 1.1 Cart API çš„ GetUserTags æ–¹æ³•

Cart API çš„ GetUserTags æ–¹æ³•æœƒå–å¾—æœƒå“¡æ–¼è³¼ç‰©è»Šæµç¨‹ä¸­çš„ã€Œæœƒå“¡æ¨™ç±¤ã€ï¼Œæ¨™ç±¤å°‡ç”¨æ–¼ä¿ƒéŠ·å¼•æ“åˆ¤æ–·ç›®æ¨™å°è±¡ï¼ˆå¦‚ï¼šå…¨æœƒå“¡ã€æ–°æœƒå“¡ã€æŒ‡å®šå¡åˆ¥æœƒå“¡ï¼‰ã€‚

<br>

```csharp
/// <summary>
/// å–å¾—æœƒå“¡æ¨™ç±¤
/// </summary>
/// <param name="context">CartContext</param>
/// <param name="vipMember">VipMemberBriefDataEntity</param>
/// <returns>æœƒå“¡æ¨™ç±¤</returns>
private string[] GetUserTags(CartContext context, VipMemberBriefDataEntity? vipMember)
{
    var userTags = new List<string>
    {
        PromotionEngineConstants.AllUserScope
    };

    if (context.Data.HasCrmShopContract == true)
    {
        userTags.Add($"{PromotionEngineConstants.CrmShopMemberCard}:{context.Data.CrmMemberTier.CrmShopMemberCardId}");
    }

    if (vipMember == null)
    {
        return userTags.ToArray();
    }

    if (vipMember.IsFirstPurchase)
    {
        userTags.Add(PromotionEngineConstants.FirstPurchase);
    }

    return userTags.ToArray();
}
```

<br>

ğŸ“ è¼¸å‡ºç¯„ä¾‹

<br>

```json
["AllUserScope"]
```

<br>

```json
["AllUserScope", "CrmShopMemberCard:5"]
```

<br>

```json
["AllUserScope", "FirstPurchase"]
```

<br>

### 1.2 ä¿ƒè³¼å‰å°çµ„æˆ Threshold

ä¿ƒè³¼å‰å°æœƒæ ¹æ“š RewardPointRuleList çµ„æˆæ´»å‹•æ¢ä»¶é–€æª»ï¼ˆThresholdï¼‰ï¼Œä»¥ä¾¿ä¿ƒéŠ·å¼•æ“åœ¨åˆ¤æ–·æ˜¯å¦çµ¦é»æ™‚ï¼Œä¾æ“šä¸åŒæœƒå“¡å¡åˆ†çµ„é€²è¡Œã€‚

<br>

```csharp
/// <summary>
/// çµ„æˆä¿ƒè³¼å¼•æ“è¦å‰‡
/// </summary>
/// <param name="promotionEngineId">PromotionEngine_Id</param>
/// <param name="entity">PromotionBaseEntity</param>
/// <returns>PromotionEngine_Rule Json String</returns>
public string GetPromotionEngineRule(long promotionEngineId, PromotionBaseEntity entity)
{
    //// çµ„æˆæ´»å‹•æ¢ä»¶éšå±¤
    var thresholds = new Dictionary<string, RewardReachPriceWithPointThreshold>();

    //// çµ¦é»æ¢ä»¶
    entity.RewardPointRuleList.ForEach(rewardPointRule =>
    {
        if (decimal.TryParse(rewardPointRule.Condition.ToString(), out var reachPrice) == false || rewardPointRule.Point == null)
        {
            throw new ApplicationException("æ´»å‹•æŠ˜æŠµæ¢ä»¶æœ‰èª¤");
        }

        var rewardReachPriceWithPointThreshold = new RewardReachPriceWithPointThreshold()
        {
            ReachPricePointPairs = new List<ReachPricePointPair>()
            {
                new ReachPricePointPair(reachPrice, rewardPointRule.Point.Value)
            }
        };

        //// è‹¥ CrmShopMemberCardId = 0ï¼Œä»£è¡¨æ´»å‹•é©ç”¨å…¨é«”æœƒå“¡
        var crmShopMemberCard = rewardPointRule.CrmShopMemberCardId == 0 ?
            nameof(AllUserScope) :
            $"CrmShopMemberCard:{rewardPointRule.CrmShopMemberCardId}";

        thresholds.Add(crmShopMemberCard, rewardReachPriceWithPointThreshold);
    });
}
```

<br>

ğŸ“ è¼¸å‡ºç¯„ä¾‹

<br>

```json
{
  "AllUserScope": {
    "ReachPricePointPairs": [
      { "ReachPrice": 1000, "Point": 50 }
    ]
  },
  "CrmShopMemberCard:5": {
    "ReachPricePointPairs": [
      { "ReachPrice": 800, "Point": 80 }
    ]
  }
}
```

<br>

æœƒå“¡æ¨™ç±¤ï¼ˆUserTagsï¼‰èˆ‡ Threshold Key å°æ‡‰ï¼šå‰å°çµ„æˆ UserTagsï¼Œå¾Œå° Thresholds ä»¥ç›¸åŒ Tag ç‚º Keyï¼Œä¿ƒéŠ·å¼•æ“åœ¨åŸ·è¡Œæ™‚åšäº¤é›†æ¯”å°ã€‚

<br>

CrmShopMemberCardId = 0ï¼šä»£è¡¨é©ç”¨æ‰€æœ‰æœƒå“¡ï¼Œä½¿ç”¨ AllUserScopeã€‚

<br>

---

## 2. PromotionRules

### 2.1 å–ç”¨ this.Rules

- IsMatchedDate => çœ‹æ´»å‹•çš„ Since / Until
- Enabled

<br>

### 2.2 Priority

Priority çœ‹èµ·ä¾†æ˜¯æœ‰å…§å®šæ’åº

<br>

### 2.3 IsSkipped

IsSkipped åœ¨å¼•æ“æœ‰çš„ rule æœƒå®šç¾© skip RuleId

<br>

---

## 3. MatchedProcess

æ´»å‹•å» loop é€™å€‹è³¼ç‰©è»Šçš„å•†å“

<br>

### 3.1 å–å¾— threshold

<br>

### 3.2 GetMatchedProductScopeItems

IsInScopeï¼šç¢ºèª PurchaseItems æ˜¯å¦åœ¨ productItem.Tags è£¡é¢ (TagProductScope)

<br>

OrderBy SalePrice

<br>

thenOrderBy PromotionEngineId

<br>

### 3.3 TotalPrice

TotalPrice = SalePrice çš„ Sum

<br>

### 3.4 è¨ˆç®—æ–¹å¼

**ç¨ç«‹è¨ˆç®—**ï¼šProduct.GroupKey æœƒæ˜¯ TSï¼Œæ¯ä¸€å¼µ TS.SalessPrice * priceRateAndPointPair.Rateï¼Œæœ€å¾Œ SUM å‡ºé€™æ•´å¼µ TG çš„ points

<br>

**åˆä½µè¨ˆç®—**ï¼šTotalPrice ç›´æ¥ * priceRateAndPointPair.Rate

<br>

### 3.5 ç”¢ç”Ÿ PromotionRecord

- PromotionId
- SourceType = Promotion
- Group = CartCalculate
- Point = æœƒæœ‰æœ€å¤§çµ¦é»æ•¸çš„é™åˆ¶
- PurchasedItemIds
- NeedAmortization = no need to æ”¤æ

<br>

---

## 4. MismatchedProcess

### 4.1 AddPromotionInstruction

#### 4.1.1 GetThreshold

<br>

#### 4.1.2 æ´»å‹•è™•ç†æµç¨‹

æœ‰ä¸­æ´»å‹•æ‰¾ä¸‹ä¸€éšï¼Œå¡«ä¸Š DisplayHintInstruction çš„ï¼š

<br>

- PromotionRuleId
- SourceType
- State = HintInfo

<br>

```json
{
  "LackSalesChannel": "ä½å…ƒè™•ç†",
  "LackOfPrice": "Math.Max(targetPair.ReachPrice - purchasedItemPrice, 0)",
  "Fulfilment": "targetPair"
}
```

<br>

#### 4.1.3 PurchaseItem æ¨™è¨˜

æ¯ä¸€å€‹ purchaseItem éƒ½æœ‰ Flagsï¼Œè¦åœ¨æ²’ä¸­è©²æ´»å‹•çš„ purchaseItem æ›ä¸Šå°æ‡‰ Promotion çš„ TagsWhenMismatched

<br>

---

## 5. æ’é™¤å•†å“

GetExcludePurchasedItemsï¼šæŠŠæ¯ä¸€å€‹æ’é™¤çš„å•†å“çš„ SalePrice å»ç§»é™¤ TotalPrice

<br>

---

## 6. çµ„åˆå•†å“

- çµ„åˆå•†å“æœƒä¸­åªçœ‹çµ„åˆå•†å“ Major æœ¬èº«æ˜¯å¦è¢«æŒ‡å®šæˆ–æ’é™¤
- çµ‚ç©¶æ”¤åœ¨ä¸‹é¢
- çµ„åˆå•†å“ä¸»å•†å“æ²’æœ‰æ–™è™Ÿï¼Œä¸è€ƒæ…®æ­¤æƒ…å¢ƒ
- å­å•†å“è¢«æ’é™¤ä¹Ÿè¦æ•´é«”æœ‰ä¸­ä¸¦æ”¤æ

<br>

---

## 7. æ”¤æèˆ‡QTY

è¨è«–ä¸²ï¼šhttps://91app.slack.com/archives/C089M6NLMN0/p1742201481723199

<br>

TG çµ¦é»å…¬å¼ï¼šç¸½å•†å“å¯¦ä»˜é‡‘é¡ * å›è´ˆåŒ¯ç‡ï¼Œç„¡æ¢ä»¶æ¨å»

<br>

é»æ•¸æ”¤æå…¬å¼ï¼šå¯å¾—é»æ•¸ * (å•†å“å¯¦ä»˜é‡‘é¡ / ç¸½å•†å“å¯¦ä»˜é‡‘é¡)ï¼Œè‹¥æœ‰é¤˜æ•¸ä¾åºåŠ åœ¨æœ€å¾ŒåŠ å…¥è³¼ç‰©è»Šçš„å•†å“ä¸Š

<br>

ä¸€å€‹ TS æœ‰å¤šå€‹ QTYï¼ŒæŒ‰ç…§ QTY æ”¤æçµ¦äº†å¤šå°‘é»æ•¸

<br>

æ”¤æå®Œç„¡æ¢ä»¶æ¨å»

<br>

æ¨å»çš„å°æ•¸é›†åˆå‡ºä¾†åšç¬¬äºŒè¼ªçš„æ”¤æ

<br>

å¾ŒåŠ å…¥çš„æœƒå…ˆæ”¤

<br>

é ˆæ’é™¤é‹è²»

<br>

æ”¤åˆ° QTYï¼Œé¤˜æ•¸ä¾åºä¾"ä¸»å–®å…§äº¤æ˜“åºè™Ÿæœ€å°çš„"åŠ å› (CrmSalesOrderSlave_OuterOrderSlaveCode å°çš„)

<br>

---

## 8. åœˆå•†å“çµæ§‹

```json
"IncludedProductScopes": [
  {
    "ProductScopeType": "NineYi.Msa.Tagging.TagProductScope",
    "Tag": "Collection:d_310414867779699456"
  },
  {
    "ProductScopeType": "NineYi.Msa.Tagging.TagProductScope",
    "Tag": "OuterIdTag:5847"
  }
]
```

<br>

**DB**

<br>

æ–™è™Ÿï¼šPromotionTagSlave_TargetCode

<br>

---

## 9. åœˆæœƒå“¡

```json
"MatchedUserScopes": [
  {
    "UserScopeType": "NineYi.Msa.Tagging.TagUserScope",
    "Tag": "CrmShopMemberCard:1"
  },
  {
    "UserScopeType": "NineYi.Msa.Tagging.TagUserScope",
    "Tag": "CrmShopMemberCard:2"
  }
]
```

<br>

---

## 10. åœˆLocation

```json
"IncludedLocationScopes": [
  {
    "LocationScopeType": "NineYi.Msa.Tagging.TagLocationScope",
    "Tag": 5848
  }
]
```

<br>

---

## 11. ä¿ƒè³¼å‰å°ç™¼é€

ğŸ“Œ ä¿ƒè³¼å¼•æ“ SalepageSkuItemList æµç¨‹èªªæ˜

<br>

â˜˜ï¸ CreateProcessContextAsync => ProcessContext.SalepageSkuItemList

<br>

| æ¬„ä½åç¨± | èªªæ˜ |
|---------|------|
| SalepageId | éŠ·å”®é ç·¨è™Ÿ |
| OuterId | å•†å“å¤–éƒ¨ç·¨è™Ÿï¼ˆSKUï¼‰ |
| Price | å–®ç­†åƒ¹æ ¼ |
| Tags | ä¿ƒè³¼æ¨™ç±¤ï¼ˆCollection:f_xxxxï¼‰ |

<br>

ğŸ§ª è¨ˆç®—å‰ CreateShoppingCartContextï¼Œå»ºç«‹ productItemï¼Œå¼•æ“æœƒ Mapping æˆ purchasedItem

<br>

```csharp
CreateShoppingCartContext

//// å°‡ CollectionId è²¼åˆ° SalePage ä¸Šé¢åŒæ™‚å°‡å•†å“è³‡æ–™åŠ å…¥è³¼ç‰©è»Š
foreach (var item in context.SalepageSkuItemList)
{
    var productItem = new ProductItem
    {
        Id = item.SalepageId,
        SkuId = item.SkuId,
        ListPrice = item.Payment,
        Tags = item.Tags,
        CartId = item.CartId,
        CartExtendInfoItemType = item.CartExtendInfoItemType,
        CartExtendInfoItemGroup = item.CartExtendInfoItemGroup,
        CartExtendInfos = item.CartExtendInfos.Select(i => new CartExtendInfo
        {
            RuleTypeDef = i.RuleTypeDef,
            RuleId = i.RuleId,
            RelatedItemCartIds = i.RelatedItemCartIds,
            RelatedSubItemCount = i.RelatedSubItemCount
        })
    };

    ISet<string> flags = item.Flags.ToHashSet();
    shoppingCartContext.Purchase(item.Index, productItem, flags);
}
```

<br>

**Purchase**

<br>

ProductItem è³¦å€¼çµ¦ PurchasedItem

<br>

TotalPrice += purchasedItem.SalePrice

<br>

SalePrice = item.ListPrice

<br>

ğŸ›’ Saleapge Collection è²¼æ¨™

<br>

**API**ï¼šapi/salepage-collections:match

<br>

**Response**

<br>

```
List<SalepageCollectionMapping> Mapping
    SalepageId long
    Matched List<SalepageCollectionMatched>
        - PromotionEngineId
        - SalepageCollectionId
        - SourceId (å•†å“åŠ åƒ¹è³¼åœ¨ç”¨)
```

<br>

```csharp
GetMatchedSalepageCollectionAsync (æ¯å€‹ salepage å°æ‡‰å¤šå€‹ Tags => é€²åˆ°å¼•æ“)
salepageIdList æ‰“ GetMatchedSalepageCollectionAsync (api/salepage-collections:match)

var match = await this._collectionHttpClient.GetMatchedSalepageCollectionAsync(
    new GetMatchedSalepageCollectionRequest
    {
        SalepageIds = idList,
        MatchType = nameof(GetMatchedSalepageCollectionRequestMatchTypeEnum.FilterByPromotions),
        ExpectedPromotionsOnActiveTime = this.GetDateTimeNow(),
        ExpectedPromotionsExtentDurationSeconds = config.ExtentDurationSeconds, //// å¤šå– 30min å¾Œè¦é–‹å§‹çš„æ´»å‹•
    },
    this._collectionHttpClient.GetRequestHeaders(context.ShopId));

çµ„ç¹”æˆï¼šsalepageIdï¼šå°æ‡‰çš„ match è³‡æ–™å€‘(tag / promotionId / salepageId)
```

<br>

â˜˜ï¸ æ–™è™Ÿè²¼æ¨™ GetOuterIdTagsAsync

<br>

é€™æ®µæœŸé–“æœ‰ä¸­çš„æ´»å‹•æ‹‰å‡ºä¾†çš„ tag æ‹‰å‡ºä»–å€‘çš„ typecode (PromotionTag SQL DB) & salesProduct (S3)

<br>

æ¯”å°ç¾åœ¨æ‰‹ä¸Šçš„ SalepageSkuItemList.OuterId çœ‹æœ‰æ²’æœ‰ä¸­

<br>

ğŸ§ LoadRules æœƒæŠŠè³‡æ–™ Mapping é€²å»å¼•æ“

<br>

```csharp
//////// å„ rule å¯¦ä½œçš„ PromotionEngineRule
dynamic jsonRuleObject = this.GetRuleObject(typeof(RewardReachPriceWithRatePoint2).FullName, promotionEngineId, entity);
var ruleList = context.ProcessRuleList.SelectMany(i => i.RuleList).ToList();
result.TypeFullName = typeFullName;
result.Id = promotionEngineId;
result.Name = entity.Name;
result.Enabled = true;
result.Description = entity.Description;
result.Since = entity.StartDateTime;
result.Until = entity.EndDateTime;
result.UpdatedAt = this.GetDateTimeNow();
result.Cyclable = entity.IsCyclable;
result.Accumulated = entity.Accumulated;
result.IncludedProductScopes = this._includedProductScopes;
result.ExcludedProductScopes = this._excludedProductScopes;
result.IncludeRegionScopes = this._includeRegionScopes;
result.MatchedUserScopes = this._matchedUserScopes;
result.VisibleUserScopes = this._visibleUserScopes;
result.MatchedSalesChannels = (int)SalesChannelAdapter.ToSalesChannelEnum(entity.TargetPlatformTypeList);
result.VisibleSalesChannels = (int)SalesChannelAdapter.ToSalesChannelEnum(this.GetVisiblePlatformTypeList(entity));
result.IncludedLocationScopes = this._includedLocationScopes;
_promotionEngine.LoadRules(RuleLoader.AssemblyFullName, ruleList.Select(i => i.Rule).ToList());
this.SerializePromotionRule(jsonRuleObject);

//////// åœ¨è¨ˆç®—å‰
LoadRuleAndModifyPriority
_promotionEngine.LoadRules(RuleLoader.AssemblyFullName, ruleList.Select(i => i.Rule).ToList());
```

<br>

ğŸ€ è¨ˆç®—å…¥å£é»

<br>

EngineCalculate

<br>

æº–å‚™ ShoppingCartContext â‡’ é€åˆ° NineYi.Msa.Promotion.Engine.ProcessPromotion

<br>

---

## 12. Thresholdsçµæ§‹

ä¾ç…§ç­‰ç´šçµ¦äºˆé–€æª»ä¸åŒ

<br>

```json
"CrmShopMemberCard:5": {
  "ReachPricePointPairs": [
    {
      "ReachPrice": 123.0,
      "Point": 33.0
    }
  ]
}
```

<br>

**Coupon**

<br>

```json
{
  "Thresholds": {
    "CrmShopMemberCard:30": {
      "ReachPriceCouponPairs": [
        {
          "ReachPrice": 1.0,
          "Coupons": [
            {
              "Id": "1865",
              "Qty": 1
            }
          ]
        }
      ]
    },
    "CrmShopMemberCard:31": {
      "ReachPriceCouponPairs": [
        {
          "ReachPrice": 1.0,
          "Coupons": [
            {
              "Id": "1865",
              "Qty": 1
            }
          ]
        }
      ]
    },
    "CrmShopMemberCard:32": {
      "ReachPriceCouponPairs": [
        {
          "ReachPrice": 1.0,
          "Coupons": [
            {
              "Id": "1865",
              "Qty": 1
            }
          ]
        }
      ]
    }
  }
}
```

<br>

---

## 13. åˆä½µèˆ‡ç¨ç«‹è¨ˆç®—

**åˆä½µè¨ˆç®— TG**ï¼šPointCalculateTypeï¼šRewardPointCalculateType.Merged

<br>

**ç¨ç«‹è¨ˆç®— TS**ï¼šRewardPointCalculateType.Independent

<br>

---

## 14. é—œæ–¼åƒ… TS æ”¤æé€€æ¬¾ç‚ºç”šéº¼æ¶ˆè²»è€…ä»æœƒæ‹¿åˆ°æ¯”è¼ƒå¤šå¾—ç¾è±¡

<br>

**VSTS é€£çµ**ï¼šhttps://91appinc.visualstudio.com/G11n/_workitems/edit/498163

<br>

**æ¡ˆä¾‹è³‡è¨Š**

<br>

- Shopï¼š11
- Memberï¼š98330069 / 123456
- TGï¼šTG250606T00002

<br>

è©²ç­†è¨‚å–®æœ‰3å€‹TSï¼Œé‡‘é¡åŠè¨‚å–®ç‹€æ…‹å¦‚ä¸‹ï¼š

<br>

- TS250606T000002 > è¨‚å–®å·²å–æ¶ˆ(HK$ 77)
- TS250606T000003 > å·²æˆç«‹ (HK$999.99)
- TS250606T000004 > è¨‚å–®å·²å–æ¶ˆ (HK$ 199.8)

<br>

**æ´»å‹•åˆ†æ**

<br>

æœ‰ä¸­ä»¥ä¸‹å¹¾å€‹æ´»å‹•ï¼Œç†è«–æ‡‰åªç®—TS250606T000003è¦çµ¦å¤šå°‘é»ï¼Œé æœŸå¦‚ä¸‹ï¼š

<br>

- (7041)æ»¿199ï¼Œ6/8å°±çµ¦50%é»æ•¸ï¼š499é»
- (7039)æ»¿100æŒ‡å®š6/8çµ¦100é»ï¼Œå¯å¾ªç’°ï¼š900é»

<br>

ç›®å‰æ˜¯çµ¦ï¼š

<br>

- (7041)æ»¿199ï¼Œ6/8å°±çµ¦50%é»æ•¸ï¼š500é»
- (7039)æ»¿100æŒ‡å®š6/8çµ¦100é»ï¼Œå¯å¾ªç’°ï¼š940é»

<br>

**è§€å¿µèªªæ˜**

<br>

ğŸ‘‰ ä½ å› ç‚ºã€Œæ›¾æœ‰å…¶ä»–äººåŠ æˆã€ï¼Œç¾åœ¨é›–ç„¶ä»–å€‘èµ°äº†ï¼Œä½ å»ã€Œç¨äº«ã€çå‹µï¼Œæ‰€ä»¥æœƒè®Šå¤š(åœ¨ã€Œè¨ˆç®—ç¸½é»æ•¸ã€çš„ç•¶ä¸‹ï¼Œé‚„æ˜¯æœ‰å¹«ä½ ã€Œå¢Šé«˜æ•´é«”æ»¿é¡æ¬¡æ•¸ã€ï¼)

<br>