# ğŸ”„ NMQV2 æ–‡ä»¶

<br>

## ğŸ“– ç›®éŒ„
  - [ğŸ”§ .NET Framework å®‰è£](#-net-framework-å®‰è£)
  - [ğŸ’» IDE å•é¡Œæ’é™¤](#-ide-å•é¡Œæ’é™¤)
  - [âš™ï¸ NMQ çµ„ä»¶æ¡†æ¶éœ€æ±‚](#ï¸-nmq-çµ„ä»¶æ¡†æ¶éœ€æ±‚)
  - [ğŸ§ª æœ¬æ©Ÿé–‹ç™¼æ¸¬è©¦æ­¥é©Ÿ](#-æœ¬æ©Ÿé–‹ç™¼æ¸¬è©¦æ­¥é©Ÿ)
  - [ğŸ”„ æ›´æ–°ç·šä¸Š NMQ ç‹€æ…‹](#-æ›´æ–°ç·šä¸Š-nmq-ç‹€æ…‹)
  - [ğŸš€ NMQ V2 çš„ QA éƒ¨ç½²æ­¥é©Ÿ](#-nmq-v2-çš„-qa-éƒ¨ç½²æ­¥é©Ÿ)
  - [ï¿½ NMQV2 éƒ¨ç½²å¾Œç‰ˆè™Ÿç¢ºèªä½ç½®](#-nmqv2-éƒ¨ç½²å¾Œç‰ˆè™Ÿç¢ºèªä½ç½®)
  - [ï¿½ğŸ”€ åˆ‡æ›ç’°å¢ƒæ¸¬è©¦æ–¹æ³•](#-åˆ‡æ›ç’°å¢ƒæ¸¬è©¦æ–¹æ³•)

<br>

---

## ğŸ”§ .NET Framework å®‰è£

**Microsoft .NET Framework åƒè€ƒçµ„ä»¶å®‰è£**ï¼š

<br>

å®‰è£ç¶²å€ï¼šhttps://www.nuget.org/packages/microsoft.netframework.referenceassemblies.net45

<br>

**.NET Framework 4.5.2 Developer Pack é›¢ç·šå®‰è£å™¨**ï¼š

<br>

åƒè€ƒæ–‡ä»¶ï¼šhttps://www.cnblogs.com/rqcim/p/15882239.html

<br>

é€™å€‹å®‰è£åŒ…æä¾›äº†å®Œæ•´çš„é–‹ç™¼ç’°å¢ƒæ”¯æ´ï¼Œé©ç”¨æ–¼é›¢ç·šç’°å¢ƒçš„å®‰è£éœ€æ±‚

<br>

---

## ğŸ’» IDE å•é¡Œæ’é™¤

**Visual Studio 2022 ç›¸å®¹æ€§å•é¡Œ**ï¼š

<br>

å¦‚æœåœ¨ä½¿ç”¨ Visual Studio 2022 æ™‚é‡åˆ° IDE å ±éŒ¯å•é¡Œï¼Œéœ€è¦å®‰è£ Visual Studio 2019 æ‰èƒ½è§£æ±º

<br>

**å•é¡Œè©³ç´°èªªæ˜èˆ‡è§£æ±ºæ–¹æ¡ˆ**ï¼š

<br>

åƒè€ƒè¨è«–ï¼šhttps://www.reddit.com/r/VisualStudio/comments/x9w4ep/vs_2022_keeps_asking_me_to_download_net_framework/?rdt=58431

<br>

é€™å€‹å•é¡Œé€šå¸¸å‡ºç¾åœ¨ VS 2022 æŒçºŒè¦æ±‚ä¸‹è¼‰ .NET Framework çš„æƒ…æ³ä¸‹ï¼Œé€éå®‰è£ VS 2019 å¯ä»¥è§£æ±ºç›¸å®¹æ€§å•é¡Œ

<br>

---

## âš™ï¸ NMQ çµ„ä»¶æ¡†æ¶éœ€æ±‚

**NMQ Dispatcher æ¡†æ¶éœ€æ±‚**ï¼š

<br>

éœ€è¦å®‰è£ .NET Core 2.1

<br>

**å…¶ä»–å­ NMQ çµ„ä»¶æ¡†æ¶éœ€æ±‚**ï¼š

<br>

éœ€è¦å®‰è£ .NET Framework 4.5

<br>

**é‡è¦æé†’**ï¼š

<br>

ä¸åŒçš„ NMQ çµ„ä»¶æœ‰ä¸åŒçš„æ¡†æ¶éœ€æ±‚ï¼Œè«‹ç¢ºä¿æŒ‰ç…§çµ„ä»¶é¡å‹å®‰è£æ­£ç¢ºçš„æ¡†æ¶ç‰ˆæœ¬ï¼Œé¿å…ç›¸å®¹æ€§å•é¡Œ

<br>

---

## ğŸ§ª æœ¬æ©Ÿé–‹ç™¼æ¸¬è©¦æ­¥é©Ÿ

**æ­¥é©Ÿ 1ï¼šè¤‡è£½å°ˆæ¡ˆ**

<br>

è¤‡è£½ SCM.NMQV2 / NMQV2 å„²å­˜åº«åˆ°æœ¬æ©Ÿ

<br>

**æ­¥é©Ÿ 2ï¼šè¨­å®šä»»å‹™è¨­å®šæª”**

<br>

å‰å¾€ NMQV2 å°ˆæ¡ˆ â†’ Tool folder â†’ DebugConsole proj â†’ tasksetting.json å¡«å€¼

é€™è£¡çš„è³‡æ–™è¡¨ç¤º task data çš„ payload

<br>

**æ¡ˆä¾‹ 1ï¼šThirdPartyPaymentReCheck**

```json
{
  "Job": {
    "Name": "ThirdPartyPaymentReCheck",
    "AssemblyRoot": "C:\\91APP\\nineyi.scm.nmqv2\\SCM\\Frontend\\NMQV2",
    "AssemblyPath": "bin\\Debug",
    "AssemblyName": "NineYi.SCM.Frontend.NMQV2",
    "ClassName": "NineYi.SCM.Frontend.NMQV2.ThirdPartyPayment.ThirdPartyPaymentReCheckProcess"
  },
  "Id": 2,
  "Data": "{\"ThirdPartyPaymentType\":\"TwoCTwoP\",\"startTime\":\"2023-12-16 22:15:00\",\"endTime\":\"2023-12-20 23:40:00\",\"PaymentServiceProvider\":\"PaymentMiddleware\"}"
}
```

<br>

**æ¡ˆä¾‹ 2ï¼šRefundFinish**

```json
{
  "Job": {
    "Name": "TwoCTwoPRefundRequestFinish",
    "AssemblyRoot": "C:\\91APP\\nineyi.scm.nmqv2\\SCM\\Frontend\\NMQV2",
    "AssemblyPath": "bin\\Debug",
    "AssemblyName": "NineYi.SCM.Frontend.NMQV2",
    "ClassName": "NineYi.SCM.Frontend.NMQV2.ThirdPartyPayments.PaymentMiddleWareRefundRequestFinishProcess"
  },
  "Id": 2,
  "Data": "{\"RefundRequestIds\":[5610],\"TradesOrderGroupId\":22409,\"PayType\":\"TwoCTwoP\"}"
}
```

<br>

**æ­¥é©Ÿ 3ï¼šè¨­å®šç’°å¢ƒè¨­å®šæª”**

<br>

è¨­å®š NMQV2 config åˆ°å°æ‡‰çš„å¸‚å ´ç’°å¢ƒ

<br>

**æ­¥é©Ÿ 4ï¼šç¨‹å¼ç¢¼è·¯å¾‘è¨­å®š**

<br>

åœ¨ NMQV2 å°ˆæ¡ˆçš„ Program.cs ä¸­è¨­å®šæ­£ç¢ºè·¯å¾‘

ç¯„ä¾‹ï¼š`File.ReadAllText(@"C:\91APP\NMQ\nineyi.nmqv2\Tools\DebugConsole\tasksettings.json")`

<br>

**æ­¥é©Ÿ 5ï¼šè¨­å®šèµ·å§‹å°ˆæ¡ˆ**

<br>

è¨­å®š NMQV2.NineYi.SCM.Fronted.NMQV2 ç‚ºèµ·å§‹å°ˆæ¡ˆ

è·¯å¾‘ï¼š`C:\91APP\NMQ\nineyi.scm.nmqv2\SCM\Frontend\NMQV2\NineYi.SCM.Frontend.NMQV2.csproj`

<br>

**æ­¥é©Ÿ 6ï¼šåµéŒ¯è¨­å®š**

<br>

åœ¨ (SCMNMQ) properties â†’ åµéŒ¯ â†’ Debug.exe ä¸­è¨­å®šï¼š

`C:\91APP\nineyi.nmqv2\Tools\DebugConsole\bin\Debug\NineYi.NMQV2.DebugConsole.exe`

<br>

---

## ğŸ”„ æ›´æ–°ç·šä¸Š NMQ ç‹€æ…‹

**1. æ›´æ–° NMQ ç‹€æ…‹ç‚º Ready èªæ³•**

<br>

```sql
USE NMQV2DB

--Backup Begin
SELECT
	*
INTO MATempDB.dbo.tmpNMQV2DB_Task_VSTS109027
FROM dbo.Task WITH (NOLOCK)
WHERE Task_Id = 1167609
AND Task_JobId = 213
--Backup End

--Update Begin
UPDATE dbo.Task
SET Task_Status = 'Ready'
,Task_UpdatedTimes = Task_UpdatedTimes % 255 + 1
,Task_UpdatedDatetime = GETDATE()
,Task_UpdatedUser = 'VSTS109027'
WHERE Task_Id = 1167609
AND Task_JobId = 213
--Update End

--Verify Begin
SELECT
	*
FROM dbo.Task WITH (NOLOCK)
WHERE Task_Id = 1167609
AND Task_JobId = 213
--Verify End
```

<br>

**2. å¡å…¥ NMQ Task èªæ³•**

<br>

```sql
--Step03 æ–°å¢æ’ç¨‹ä»»å‹™ ShippingOrderFinish (å…¨å®¶å–è²¨å®Œæˆ)
USE NMQV2DB
GO
 
DECLARE @CreateDateTime DATETIME = GETDATE()
,@NmqJobId INT = -1
,@NmqJobName varchar(100) ='ShippingOrderFinish'
,@DataType varchar(30)  = 'R96'
,@CreateUser varchar(30) = 'VSTS109011';


SELECT @NmqJobId = [Job_Id]
FROM [NMQV2LS].[NMQV2DB].[dbo].[Job] with(nolock)
WHERE [Job_Name] = @NmqJobName

-- æ–°å¢ NMQV2 æ‰¹æ¬¡è™•ç†
INSERT INTO [NMQV2DB].[dbo].[Task]
([Task_JobId]
,[Task_Status]
,[Task_DispatchTime]
,[Task_StartTime]
,[Task_ErrorCount]
,[Task_Data]
,[Task_ServerId]
,[Task_CreatedDatetime]
,[Task_CreatedUser]
,[Task_UpdatedTimes]
,[Task_UpdatedDatetime]
,[Task_UpdatedUser]
,[Task_ValidFlag])
VALUES
(@NmqJobId
,'Ready'
,@CreateDateTime
,@CreateDateTime
,0
, @DataType
,1
,@CreateDateTime
,@CreateUser
,0
,@CreateDateTime
,@CreateUser
,1)
```
---

## ğŸš€ NMQ V2 çš„ QA éƒ¨ç½²æ­¥é©Ÿ

**æ­¥é©Ÿ 1ï¼šç¢ºèª CI Master å»ºæ§‹ç‹€æ…‹**

<br>

ç¢ºèªè©² NMQ CI Master å·²ç¶“ Build å®Œæˆï¼Œä¸¦æˆåŠŸä¸Šå‚³è‡³ Artifact

<br>

**CI Master ç¶²å€**ï¼šhttp://ci-master.91dev.tw:8080/

<br>

**æ­¥é©Ÿ 2ï¼šé—œé–‰ NMQV3 Dashboard Router**

<br>

åœ¨éƒ¨ç½²å‰å…ˆé—œé–‰ Router ä»¥ç¢ºä¿ç³»çµ±ç©©å®šæ€§

<br>

**NMQV3 Dashboard ç¶²å€**ï¼šhttps://nmqv3-dashboard.qa1.hk.91dev.tw/router-management/

<br>

**æ­¥é©Ÿ 3ï¼šåŸ·è¡Œéƒ¨ç½²ç¨‹åº**

<br>

åŸ·è¡Œ CI MY éƒ¨ç½²ç¨‹å¼è‡³ NMQV3

<br>

**éƒ¨ç½²ç¶²å€**ï¼šhttps://ci.my.91app.io/view/Deploy%20Global%20QA/job/NineYi.Global.NMQV3%20-%20QA/

<br>

**æ­¥é©Ÿ 4ï¼šç³»çµ±é‡å•Ÿ**

<br>

é—œæ©Ÿå¾Œé‡å•Ÿç³»çµ±ä»¥ç¢ºä¿æ–°ç‰ˆæœ¬æ­£å¸¸è¼‰å…¥

<br>

**é‡è¦æé†’**ï¼š

<br>

- ç¢ºä¿åœ¨éƒ¨ç½²å‰é€²è¡Œå¿…è¦çš„å‚™ä»½
- æŒ‰é †åºåŸ·è¡Œå„å€‹æ­¥é©Ÿï¼Œä¸å¯è·³é
- éƒ¨ç½²å®Œæˆå¾Œé©—è­‰ç³»çµ±åŠŸèƒ½æ˜¯å¦æ­£å¸¸

<br>

---

## ï¿½ NMQV2 éƒ¨ç½²å¾Œç‰ˆè™Ÿç¢ºèªä½ç½®

**éƒ¨ç½²å¾Œç‰ˆè™Ÿæ›´æ–°æª¢æŸ¥è·¯å¾‘**ï¼š

<br>

**ä½ç½® 1ï¼šWorker Configs**

<br>

è·¯å¾‘ï¼š`D:\nmq\artifacts\worker-configs`

<br>

æ­¤ä½ç½®åŒ…å« NMQ Worker çš„è¨­å®šæª”è³‡è¨Š

<br>

**ä½ç½® 2ï¼šWorker Modules Jobs**

<br>

è·¯å¾‘ï¼š`D:\nmq\artifacts\worker-modules\jobs\Prod\NineYi\SCM.NMQV2`

<br>

æ­¤ä½ç½®åŒ…å«ç”Ÿç”¢ç’°å¢ƒ SCM NMQV2 çš„ä½œæ¥­æ¨¡çµ„

<br>

**ä½ç½® 3ï¼šNMQV2 Library**

<br>

è·¯å¾‘ï¼š`D:\Prod\NineYi\NMQV2\Library\NineYi.Scm.Frontend`

<br>

æ­¤ä½ç½®åŒ…å« NMQV2 å‰ç«¯å‡½å¼åº«æª”æ¡ˆ

<br>

**ç‰ˆè™Ÿç¢ºèªé‡è¦æé†’**ï¼š

<br>

- éƒ¨ç½²å®Œæˆå¾Œæ‡‰é€ä¸€æª¢æŸ¥ä»¥ä¸Šä¸‰å€‹ä½ç½®çš„ç‰ˆè™Ÿ
- ç¢ºä¿æ‰€æœ‰ä½ç½®çš„ç‰ˆè™Ÿéƒ½å·²æ­£ç¢ºæ›´æ–°
- å¦‚ç™¼ç¾ç‰ˆè™Ÿä¸ä¸€è‡´ï¼Œè«‹é‡æ–°åŸ·è¡Œéƒ¨ç½²ç¨‹åº
- å»ºè­°åœ¨éƒ¨ç½²å®Œæˆå¾Œå»ºç«‹æª¢æŸ¥æ¸…å–®ä»¥ç¢ºä¿ç‰ˆè™Ÿä¸€è‡´æ€§

<br>

---

## ï¿½ğŸ”€ åˆ‡æ›ç’°å¢ƒæ¸¬è©¦æ–¹æ³•

**åˆ‡æ› V2 / V3 Group Mapping**

<br>

ä»¥åˆ‡æ›åˆ°ä¸åŒçš„æ©Ÿå™¨ BRANCH (QAn) ä¸Šåšæ¸¬è©¦

<br>

æœƒæ¨é€åˆ° branchï¼š`jenkins-91app-nineyi.scm.nmqv2-feature%2FVSTS410499-QA8-SoNice-LoyaltyPointProject-1`

ä¸¦éƒ¨ç½²åˆ° QA8 ä¸Š

<br>

**æ“ä½œæ­¥é©Ÿ**ï¼š

<br>

1. ç¢ºèª JobGroup & Server é—œä¿‚
2. è§£é™¤èˆŠ Job & JobGroup é—œä¿‚
3. æ–°å¢ Job & JobGroup é—œä¿‚
4. å£“æ‰ Switch çš„è³‡æ–™

<br>

**åˆ‡æ›èªæ³•**ï¼š

<br>

```sql
-- V3åˆ‡å›V2:
Update dbo.JobSwitch(NOLOCK)
SET JobSwitch_ValidFlag =0
Where JobSwitch_JobId = 195

-- å¾©æ´»JobGroupMapping  jobid = 195ï¼Œä¸¦ä¸”æŠŠJobGroupIdæ”¹æˆ10 (QA8):
Update dbo.JobGroupMapping(NOLOCK)
SET JobGroupMapping_ValidFlag = 1,JobGroupMapping_JobGroupId = 10
Where JobGroupMapping_JobId = 195
AND JobGroupMapping_Id = 610

-- é©—è­‰
SELECT *
FROM JobGroupMapping  
Where JobGroupMapping_JobId = 195
AND JobGroupMapping_Id = 610

SELECT *
FROM JobSwitch
Where JobSwitch_JobId = 195
```

<br>

**é‚„åŸèªæ³•**ï¼š

<br>

```sql
--é‚„åŸswitch
Update dbo.JobSwitch
SET JobSwitch_ValidFlag = 1
Where JobSwitch_JobId = 195

--é‚„åŸJobGroupMapping
Update dbo.JobGroupMapping
SET JobGroupMapping_ValidFlag = 0,JobGroupMapping_JobGroupId = 1
Where JobGroupMapping_JobId = 195
AND JobGroupMapping_Id = 610

SELECT *
FROM JobGroupMapping  
Where JobGroupMapping_JobId = 195
AND JobGroupMapping_Id = 610
```

<br>

**æ¸¬è©¦ç’°å¢ƒç¯„ä¾‹**ï¼š

<br>

ä»¥åœ¨ QA8 é–‹ç™¼ç‚ºä¾‹ï¼šTYO-QA8-SCM

<br>

**é€šå ±é »é“æ¨¡æ¿**ï¼š

<br>

ç™¼é€è‡³ upd-team é »é“ï¼š

<br>

```
å›  SONICEè‡ªè¨‚çµ¦é»å¤©æ•¸å°ˆæ¡ˆæ¸¬è©¦éœ€æ±‚ï¼ŒTW-QA ç’°å¢ƒä»¥ä¸‹ NMQ Job
RewardLoyaltyPoint

é è¨ˆå°‡æœƒåšä»¥ä¸‹èª¿æ•´ï¼š
å°‡ Job å¾ V3 åˆ‡å›è‡³ V2 (ç§»é™¤ JobSwitch)
å°‡ JobGroupMapping å¾ QA åˆ‡è‡³ QA8
å¦‚æœ‰å•é¡Œå†éº»ç…©æ–¼æ­¤ thread åº•ä¸‹ç•™è¨€ï¼Œè¬è¬
```

<br>

---